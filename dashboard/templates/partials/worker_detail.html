{% include "tost.html" %}

<section class="w-full space-y-6 p-4 sm:p-6">
  <div class="theme-panel overflow-hidden rounded-2xl border shadow-sm">
    <div class="theme-panel-soft border-b px-4 py-5 sm:px-6">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="theme-text text-xl font-semibold tracking-tight">Worker Detail</h2>
          <p class="theme-muted text-sm">Performance and profile overview.</p>
        </div>
        <button
          type="button"
          class="action-btn action-btn-view"
          hx-get="{% url 'team' %}"
          hx-target="#content"
          hx-swap="innerHTML"
        >
          <iconify-icon icon="material-symbols:arrow-back-rounded" width="16" height="16"></iconify-icon>
          <span>Back To Team</span>
        </button>
      </div>
    </div>

    <div class="space-y-6 p-4 sm:p-6">
      <div class="grid grid-cols-1 gap-6 lg:grid-cols-10">
        <div class="lg:col-span-3">
          <div class="profile-card">
            {% if worker_image_url %}
              <img src="{{ worker_image_url }}" alt="{{ worker.name }}" class="profile-avatar-img">
            {% else %}
              <div class="profile-avatar-fallback">{{ worker_initials }}</div>
            {% endif %}
            <h3 class="theme-text mt-3 text-lg font-semibold">{{ worker.name }}</h3>
            <p class="theme-muted text-sm">Performance Score</p>
            <div class="star-meter stars-5 mt-2" style="--fill: {{ overall_fill_pct|floatformat:2 }}%;">
              <span class="star-meter-base">★★★★★</span>
              <span class="star-meter-fill">★★★★★</span>
            </div>
            <p class="theme-muted mt-2 text-xs">{{ overall_stars_out_of_5|floatformat:1 }}/5</p>
          </div>
        </div>

        <div class="lg:col-span-7 space-y-4">
          <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div class="detail-kpi">
              <div class="detail-head">
                <span class="detail-icon icon-type">
                  <iconify-icon icon="material-symbols:badge-outline-rounded" width="16" height="16"></iconify-icon>
                </span>
              </div>
              <p class="detail-label">Worker Type</p>
              <p class="detail-value">{{ worker.get_worker_type_display }}</p>
            </div>
            <div class="detail-kpi">
              <div class="detail-head">
                <span class="detail-icon icon-email">
                  <iconify-icon icon="material-symbols:mail-outline-rounded" width="16" height="16"></iconify-icon>
                </span>
              </div>
              <p class="detail-label">Email</p>
              <p class="detail-value">{{ worker.email|default:"-" }}</p>
            </div>
            <div class="detail-kpi">
              <div class="detail-head">
                <span class="detail-icon icon-role">
                  <iconify-icon icon="material-symbols:shield-person-outline-rounded" width="16" height="16"></iconify-icon>
                </span>
              </div>
              <p class="detail-label">Department Role</p>
              <p class="detail-value">{{ worker.department_role }}</p>
            </div>
          </div>
          <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div class="detail-kpi">
              <div class="detail-head">
                <span class="detail-icon icon-posting">
                  <iconify-icon icon="material-symbols:work-outline-rounded" width="16" height="16"></iconify-icon>
                </span>
              </div>
              <p class="detail-label">Posting</p>
              <p class="detail-value">{{ worker.posting }}</p>
            </div>
            <div class="detail-kpi">
              <div class="detail-head">
                <span class="detail-icon icon-date">
                  <iconify-icon icon="material-symbols:calendar-month-outline-rounded" width="16" height="16"></iconify-icon>
                </span>
              </div>
              <p class="detail-label">Date Of Join</p>
              <p class="detail-value">{{ worker.date_of_join|date:"Y-m-d" }}</p>
            </div>
            <div class="detail-kpi">
              <div class="detail-head">
                <span class="detail-icon icon-status">
                  <iconify-icon icon="material-symbols:flag-circle-outline-rounded" width="16" height="16"></iconify-icon>
                </span>
              </div>
              <p class="detail-label">Working Status</p>
              <span class="status-pill {{ status_meta.class_name }}">{{ status_meta.label }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-6 lg:grid-cols-5">
        <div class="theme-panel rounded-2xl border p-4 sm:p-5 lg:col-span-3">
          <h3 class="theme-text mb-3 text-base font-semibold">Worker Performance Scorecard</h3>
          <div class="radar-wrap">
            <div class="relative h-[420px] w-full max-w-[560px]">
              <canvas id="workerScoreRadarChart"></canvas>
            </div>
          </div>
        </div>
        <div class="theme-panel rounded-2xl border p-4 sm:p-5 lg:col-span-2">
          <h3 class="theme-text mb-3 text-base font-semibold">Ranks</h3>
          <div class="space-y-3">
            {% for metric in metric_rows %}
              <div class="rank-row">
                <div class="flex items-center justify-between gap-2">
                  <p class="rank-label">{{ metric.label }}</p>
                  <span class="rank-score">{{ metric.stars_out_of_5|floatformat:1 }}/5</span>
                </div>
                <div class="star-meter stars-5" style="--fill: {{ metric.fill_pct|floatformat:2 }}%;">
                  <span class="star-meter-base">★★★★★</span>
                  <span class="star-meter-fill">★★★★★</span>
                </div>
                <p class="theme-muted text-xs">{{ metric.display_value }}</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{{ radar_labels|json_script:"worker-radar-labels" }}
{{ radar_values|json_script:"worker-radar-values" }}

<style>
  .profile-card {
    border: 1px solid var(--panel-border);
    border-radius: 1rem;
    background: var(--panel-bg);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .profile-avatar-img,
  .profile-avatar-fallback {
    width: 92px;
    height: 92px;
    border-radius: 999px;
    object-fit: cover;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .profile-avatar-fallback {
    background: #dbeafe;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
    font-size: 1.15rem;
    font-weight: 800;
    text-transform: uppercase;
  }
  .detail-kpi {
    border: 1px solid var(--panel-border);
    border-radius: 0.9rem;
    background: var(--panel-bg);
    padding: 0.85rem;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
  }
  .detail-head { display: flex; justify-content: flex-end; margin-bottom: 0.35rem; }
  .detail-icon {
    width: 1.9rem;
    height: 1.9rem;
    border-radius: 0.55rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .icon-type { background: rgba(99, 102, 241, 0.15); color: #4f46e5; }
  .icon-email { background: rgba(6, 182, 212, 0.15); color: #0891b2; }
  .icon-role { background: rgba(16, 185, 129, 0.15); color: #047857; }
  .icon-posting { background: rgba(245, 158, 11, 0.15); color: #b45309; }
  .icon-date { background: rgba(59, 130, 246, 0.15); color: #1d4ed8; }
  .icon-status { background: rgba(236, 72, 153, 0.15); color: #be185d; }
  .detail-label { color: var(--panel-muted); font-size: 0.72rem; font-weight: 600; }
  .detail-value { color: var(--panel-text); font-size: 1rem; font-weight: 800; margin-top: 0.2rem; }
  .status-pill {
    margin-top: 0.3rem;
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.2rem 0.55rem;
    font-size: 0.74rem;
    font-weight: 700;
  }
  .status-joined { background: #fef3c7; color: #92400e; }
  .status-onboard { background: #dcfce7; color: #166534; }
  .status-relived { background: #fee2e2; color: #991b1b; }

  .star-meter {
    position: relative;
    display: inline-block;
    line-height: 1;
    letter-spacing: 2px;
  }
  .stars-6 { font-size: 1.45rem; }
  .stars-5 { font-size: 1.15rem; }
  .star-meter-base { color: #dbe4f0; }
  .star-meter-fill {
    position: absolute;
    left: 0;
    top: 0;
    width: var(--fill);
    overflow: hidden;
    white-space: nowrap;
    color: transparent;
    background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 52%, #60a5fa 100%);
    -webkit-background-clip: text;
    background-clip: text;
  }
  .rank-row {
    border: 1px solid var(--panel-border);
    border-radius: 0.8rem;
    padding: 0.65rem 0.7rem;
    background: var(--panel-bg);
  }
  .rank-label { color: var(--panel-text); font-size: 0.82rem; font-weight: 700; }
  .rank-score { color: var(--panel-muted); font-size: 0.76rem; font-weight: 700; }
  .radar-wrap {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
</style>

<script>
  (function () {
    const labels = JSON.parse(document.getElementById("worker-radar-labels").textContent || "[]");
    const values = JSON.parse(document.getElementById("worker-radar-values").textContent || "[]");
    const canvas = document.getElementById("workerScoreRadarChart");
    if (!canvas) return;

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (existing.dataset.loaded === "true") resolve();
          else existing.addEventListener("load", () => resolve(), { once: true });
          return;
        }
        const script = document.createElement("script");
        script.src = src;
        script.onload = () => { script.dataset.loaded = "true"; resolve(); };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function drawChart() {
      if (window.workerScoreRadar) window.workerScoreRadar.destroy();
      const isDark = document.body.classList.contains("dark-theme");
      const textColor = isDark ? "#ffffff" : "#334155";
      const gridColor = isDark ? "rgba(255,255,255,0.2)" : "rgba(148,163,184,0.25)";

      let delayed;
      window.workerScoreRadar = new Chart(canvas, {
        type: "radar",
        data: {
          labels,
          datasets: [
            {
              label: "Score",
              data: values,
              borderColor: "#7072FF",
              backgroundColor: "rgba(112, 114, 255, 0.25)",
              pointBackgroundColor: "#33C494",
              pointBorderColor: "#ffffff",
              pointRadius: 4,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            onComplete: () => {
              delayed = true;
            },
            delay: (context) => {
              let delay = 0;
              if (context.type === "data" && context.mode === "default" && !delayed) {
                delay = context.dataIndex * 180 + context.datasetIndex * 120;
              }
              return delay;
            },
          },
          plugins: {
            legend: { display: false },
          },
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: {
                stepSize: 20,
                color: textColor,
                backdropColor: "transparent",
              },
              pointLabels: { color: textColor, font: { size: 12, weight: "600" } },
              grid: { color: gridColor },
              angleLines: { color: gridColor },
            },
          },
        },
      });
    }

    if (window.Chart) {
      drawChart();
      return;
    }
    loadScript("https://cdn.jsdelivr.net/npm/chart.js").then(drawChart).catch(() => {});
  })();
</script>
