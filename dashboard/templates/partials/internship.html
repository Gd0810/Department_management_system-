<div class="w-full space-y-6 p-4 sm:p-6">
  <div class="theme-panel overflow-hidden rounded-2xl border shadow-sm transition-colors">
    <div class="theme-panel-soft border-b px-4 py-5 sm:px-6">
      <h2 class="theme-text text-xl font-semibold tracking-tight">Internship Analytics Dashboard</h2>
      <p class="theme-muted text-sm">Income, project output, and team performance overview.</p>
    </div>

    <div class="p-4 sm:p-6">
      <div class="grid grid-cols-1 gap-6">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
          <div class="kpi-card rounded-2xl border p-4">
            <p class="kpi-label">Overall Income From Internship</p>
            <p class="kpi-value">Rs {{ internship_income_total|floatformat:2 }}</p>
          </div>

          <div class="kpi-card rounded-2xl border p-4">
            <div class="mb-2 flex items-center justify-between">
              <p class="kpi-label mb-0">Internship Income Share</p>
              <span class="kpi-percent">{{ income_percentage|floatformat:2 }}%</span>
            </div>
            <div class="kpi-progress-track">
              <div class="kpi-progress-fill" style="width: {{ income_percentage|floatformat:2 }}%;"></div>
            </div>
            <p class="kpi-footnote">Compared to overall project category income</p>
          </div>

          <div class="kpi-card rounded-2xl border p-4">
            <p class="kpi-label">Overall Internship Project Count</p>
            <p class="kpi-value">{{ internship_project_total }}</p>
          </div>

          <div class="kpi-card rounded-2xl border p-4">
            <div class="mb-2 flex items-center justify-between">
              <p class="kpi-label mb-0">Internship Project Count Share</p>
              <span class="kpi-percent">{{ project_percentage|floatformat:2 }}%</span>
            </div>
            <div class="kpi-progress-track">
              <div class="kpi-progress-fill count" style="width: {{ project_percentage|floatformat:2 }}%;"></div>
            </div>
            <p class="kpi-footnote">Compared to overall project category count</p>
          </div>
        </div>

        <div class="theme-panel rounded-2xl border p-4 sm:p-5">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="theme-text text-base font-semibold">Internship Income vs Internship Project Count</h3>
          </div>
          <div class="relative h-[320px] w-full sm:h-[360px]">
            <canvas id="internshipIncomeProjectsChart"></canvas>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
          <div class="theme-panel rounded-2xl border p-4 sm:p-5">
            <div class="mb-4 flex items-center justify-between">
              <h3 class="theme-text text-base font-semibold">Top 5 Internship Projects (Income Wise)</h3>
            </div>
            <div class="relative h-[320px] w-full">
              <canvas id="topInternshipProjectsChart"></canvas>
            </div>
          </div>

          <div class="theme-panel rounded-2xl border p-4 sm:p-5">
            <div class="mb-4 flex items-center justify-between gap-3">
              <h3 class="theme-text text-base font-semibold">Top 5 Team Members (Internship Performance)</h3>
              <div class="inline-flex rounded-xl border p-1 internship-toggle-shell">
                <button type="button" class="internship-toggle-btn is-active" data-mode="projects">Project Count</button>
                <button type="button" class="internship-toggle-btn" data-mode="income">Income Earned</button>
              </div>
            </div>
            <div class="relative h-[320px] w-full">
              <canvas id="topInternshipMembersChart"></canvas>
            </div>
          </div>
        </div>

        <div class="theme-panel rounded-2xl border p-4 sm:p-5">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="theme-text text-base font-semibold">Internship Project Listing</h3>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full min-w-[680px] border-separate border-spacing-0 text-sm">
              <thead>
                <tr>
                  <th class="theme-table-head rounded-tl-xl px-4 py-3 text-left">Project Title</th>
                  <th class="theme-table-head px-4 py-3 text-left">Status</th>
                  <th class="theme-table-head px-4 py-3 text-left">Start Date</th>
                  <th class="theme-table-head rounded-tr-xl px-4 py-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for project in projects %}
                <tr>
                  <td class="theme-table-cell px-4 py-3">{{ project.title }}</td>
                  <td class="theme-table-cell px-4 py-3">
                    <span class="status-chip {% if project.status == 'finished' %}status-chip-open{% elif project.status == 'on_hold' %}status-chip-pause{% elif project.status == 'canceled' %}status-chip-stop{% else %}status-chip-live{% endif %}">
                      {{ project.get_status_display }}
                    </span>
                  </td>
                  <td class="theme-table-cell px-4 py-3">{{ project.start_date|date:"Y-m-d" }}</td>
                  <td class="theme-table-cell px-4 py-3">
                    <div class="flex flex-wrap gap-2">
                      <button type="button" class="action-btn">View</button>
                      <button type="button" class="action-btn">Update</button>
                      <button type="button" class="action-btn danger">Delete</button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td class="theme-table-cell rounded-bl-xl rounded-br-xl px-4 py-4 text-center theme-muted" colspan="4">
                    No internship projects available.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{ monthly_labels|json_script:"internship-monthly-labels" }}
{{ monthly_income|json_script:"internship-monthly-income" }}
{{ monthly_project_count|json_script:"internship-monthly-project-count" }}
{{ top_project_labels|json_script:"internship-top-project-labels" }}
{{ top_project_income|json_script:"internship-top-project-income" }}
{{ top_member_project_labels|json_script:"internship-top-member-project-labels" }}
{{ top_member_project_values|json_script:"internship-top-member-project-values" }}
{{ top_member_income_labels|json_script:"internship-top-member-income-labels" }}
{{ top_member_income_values|json_script:"internship-top-member-income-values" }}

<style>
  .internship-toggle-shell {
    border-color: var(--panel-border);
    background: var(--panel-soft-bg);
  }

  .internship-toggle-btn {
    border: 0;
    border-radius: 0.65rem;
    padding: 0.4rem 0.75rem;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--panel-muted);
    background: transparent;
    transition: all 0.2s ease;
  }

  .internship-toggle-btn.is-active {
    background: linear-gradient(90deg, var(--primary-light), var(--primary-dark));
    color: #fff;
  }

  .theme-table-head {
    border-top: 1px solid var(--panel-border);
    border-bottom: 1px solid var(--panel-border);
    background: var(--panel-soft-bg);
    color: var(--panel-text);
    font-weight: 600;
  }

  .theme-table-cell {
    border-bottom: 1px solid var(--panel-border);
    background: var(--panel-bg);
    color: var(--panel-text);
  }

  .status-chip {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.15rem 0.6rem;
    font-size: 0.72rem;
    font-weight: 600;
  }

  .status-chip-live {
    color: #166534;
    background: #dcfce7;
  }

  .status-chip-open {
    color: #1e3a8a;
    background: #dbeafe;
  }

  .status-chip-pause {
    color: #92400e;
    background: #fef3c7;
  }

  .status-chip-stop {
    color: #991b1b;
    background: #fee2e2;
  }

  body.dark-theme .status-chip-live {
    color: #bbf7d0;
    background: rgba(34, 197, 94, 0.2);
  }

  body.dark-theme .status-chip-open {
    color: #bfdbfe;
    background: rgba(59, 130, 246, 0.2);
  }

  body.dark-theme .status-chip-pause {
    color: #fde68a;
    background: rgba(234, 179, 8, 0.2);
  }

  body.dark-theme .status-chip-stop {
    color: #fecaca;
    background: rgba(239, 68, 68, 0.2);
  }

  .action-btn {
    border: 1px solid var(--panel-border);
    border-radius: 0.65rem;
    padding: 0.3rem 0.7rem;
    font-size: 0.76rem;
    font-weight: 600;
    color: var(--panel-text);
    background: var(--panel-soft-bg);
    transition: all 0.2s ease;
  }

  .action-btn:hover {
    filter: brightness(1.05);
  }

  .action-btn.danger {
    color: #ef4444;
  }

  .kpi-card {
    background: linear-gradient(145deg, color-mix(in srgb, var(--panel-soft-bg) 80%, transparent), var(--panel-bg));
    border-color: var(--panel-border);
  }

  .kpi-label {
    color: var(--panel-muted);
    font-size: 0.78rem;
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .kpi-value {
    color: var(--panel-text);
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .kpi-percent {
    color: var(--panel-text);
    font-size: 0.78rem;
    font-weight: 700;
  }

  .kpi-progress-track {
    width: 100%;
    height: 0.62rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--panel-border) 45%, transparent);
    overflow: hidden;
  }

  .kpi-progress-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, #06b6d4, #2563eb);
  }

  .kpi-progress-fill.count {
    background: linear-gradient(90deg, #22c55e, #16a34a);
  }

  .kpi-footnote {
    margin-top: 0.5rem;
    color: var(--panel-muted);
    font-size: 0.72rem;
  }
</style>

<script>
  (function () {
    const root = document.body;

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (existing.dataset.loaded === "true") resolve();
          else existing.addEventListener("load", () => resolve(), { once: true });
          return;
        }

        const script = document.createElement("script");
        script.src = src;
        script.onload = () => {
          script.dataset.loaded = "true";
          resolve();
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function loadChartJs() {
      if (window.Chart && window.Chart.registry?.plugins?.get("zoom")) return Promise.resolve();
      if (window.__internshipChartLoader) return window.__internshipChartLoader;

      window.__internshipChartLoader = loadScript("https://cdn.jsdelivr.net/npm/chart.js")
        .then(() => loadScript("https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"))
        .then(() => loadScript("https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"))
        .then(() => {
          const plugin = window.ChartZoom || window["chartjs-plugin-zoom"];
          if (plugin && !window.Chart.registry?.plugins?.get("zoom")) {
            window.Chart.register(plugin);
          }
        });

      return window.__internshipChartLoader;
    }

    function getJson(id) {
      const node = document.getElementById(id);
      if (!node) return [];
      try {
        return JSON.parse(node.textContent);
      } catch (error) {
        return [];
      }
    }

    function palette() {
      const styles = getComputedStyle(root);
      const text = styles.getPropertyValue("--panel-text").trim() || "#0f172a";
      const muted = styles.getPropertyValue("--panel-muted").trim() || "#475569";
      const primary = styles.getPropertyValue("--primary-light").trim() || "#6366f1";
      const primaryDark = styles.getPropertyValue("--primary-dark").trim() || "#4f46e5";
      const border = styles.getPropertyValue("--panel-border").trim() || "#cbd5e1";
      const softGrid = root.classList.contains("dark-theme") ? "rgba(148, 163, 184, 0.2)" : "rgba(100, 116, 139, 0.18)";
      return { text, muted, primary, primaryDark, border, softGrid };
    }

    const monthlyLabels = getJson("internship-monthly-labels");
    const monthlyIncome = getJson("internship-monthly-income").map((value) => Number(value || 0));
    const monthlyProjectCount = getJson("internship-monthly-project-count").map((value) => Number(value || 0));
    const topProjectLabels = getJson("internship-top-project-labels");
    const topProjectIncome = getJson("internship-top-project-income").map((value) => Number(value || 0));
    const topMemberProjectLabels = getJson("internship-top-member-project-labels");
    const topMemberProjectValues = getJson("internship-top-member-project-values").map((value) => Number(value || 0));
    const topMemberIncomeLabels = getJson("internship-top-member-income-labels");
    const topMemberIncomeValues = getJson("internship-top-member-income-values").map((value) => Number(value || 0));

    const topProjects = {
      labels: topProjectLabels,
      income: topProjectIncome,
    };

    const memberModes = {
      projects: {
        label: "Project Count",
        labels: topMemberProjectLabels,
        values: topMemberProjectValues,
      },
      income: {
        label: "Income Earned (Rs)",
        labels: topMemberIncomeLabels,
        values: topMemberIncomeValues,
      },
    };

    let comboChart;
    let topProjectsChart;
    let topMembersChart;
    let activeMode = "projects";

    function currencyTick(value) {
      return Number(value).toLocaleString("en-IN");
    }

    function drawCharts() {
      const colors = palette();

      if (comboChart) comboChart.destroy();
      if (topProjectsChart) topProjectsChart.destroy();
      if (topMembersChart) topMembersChart.destroy();

      const comboCtx = document.getElementById("internshipIncomeProjectsChart");
      const projectsCtx = document.getElementById("topInternshipProjectsChart");
      const membersCtx = document.getElementById("topInternshipMembersChart");
      if (!comboCtx || !projectsCtx || !membersCtx) return;

      comboChart = new Chart(comboCtx, {
        type: "bar",
        data: {
          labels: monthlyLabels,
          datasets: [
            {
              type: "bar",
              label: "Total Project Count",
              data: monthlyProjectCount,
              yAxisID: "projects",
              backgroundColor: colors.primary + "99",
              borderColor: colors.primary,
              borderWidth: 1,
              borderRadius: 8,
              maxBarThickness: 24,
            },
            {
              type: "line",
              label: "Total Income (Rs)",
              data: monthlyIncome,
              yAxisID: "income",
              borderColor: colors.primaryDark,
              backgroundColor: colors.primaryDark,
              borderWidth: 3,
              pointRadius: 4,
              pointHoverRadius: 5,
              tension: 0.35,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          hover: {
            mode: "nearest",
            intersect: false,
          },
          plugins: {
            legend: {
              labels: {
                color: colors.text,
                boxWidth: 14,
                usePointStyle: true,
              },
            },
            tooltip: {
              enabled: true,
              mode: "index",
              intersect: false,
              callbacks: {
                label: function (ctx) {
                  const yValue = ctx.parsed.y ?? 0;
                  if (ctx.dataset.yAxisID === "income") {
                    return `${ctx.dataset.label}: Rs ${currencyTick(yValue)}`;
                  }
                  return `${ctx.dataset.label}: ${yValue}`;
                },
              },
            },
            zoom: {
              pan: {
                enabled: true,
                mode: "xy",
                modifierKey: "shift",
              },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                drag: {
                  enabled: true,
                  borderColor: colors.primaryDark,
                  backgroundColor: colors.primary + "22",
                },
                mode: "xy",
              },
            },
          },
          scales: {
            x: {
              ticks: { color: colors.muted },
              grid: { color: colors.softGrid },
            },
            projects: {
              position: "left",
              ticks: { color: colors.muted, precision: 0 },
              grid: { color: colors.softGrid },
              title: { display: true, text: "Projects", color: colors.muted },
            },
            income: {
              position: "right",
              ticks: {
                color: colors.muted,
                callback: currencyTick,
              },
              grid: { drawOnChartArea: false },
              title: { display: true, text: "Income (Rs)", color: colors.muted },
            },
          },
        },
      });

      topProjectsChart = new Chart(projectsCtx, {
        type: "bar",
        data: {
          labels: topProjects.labels,
          datasets: [
            {
              label: "Total Income (Rs)",
              data: topProjects.income,
              backgroundColor: [
                colors.primary + "cc",
                colors.primaryDark + "cc",
                "#0ea5e9cc",
                "#10b981cc",
                "#f59e0bcc",
              ],
              borderColor: colors.border,
              borderWidth: 1,
              borderRadius: 8,
            },
          ],
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "nearest",
            intersect: false,
          },
          hover: {
            mode: "nearest",
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function (ctx) {
                  const yValue = ctx.parsed.x ?? 0;
                  return `Rs ${currencyTick(yValue)}`;
                },
              },
            },
            zoom: {
              pan: {
                enabled: true,
                mode: "xy",
                modifierKey: "shift",
              },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                drag: {
                  enabled: true,
                  borderColor: colors.primaryDark,
                  backgroundColor: colors.primary + "22",
                },
                mode: "xy",
              },
            },
          },
          scales: {
            x: {
              ticks: { color: colors.muted, callback: currencyTick },
              grid: { color: colors.softGrid },
            },
            y: {
              ticks: { color: colors.text },
              grid: { display: false },
            },
          },
        },
      });

      const modePayload = memberModes[activeMode];
      topMembersChart = new Chart(membersCtx, {
        type: "bar",
        data: {
          labels: modePayload.labels,
          datasets: [
            {
              label: modePayload.label,
              data: modePayload.values,
              backgroundColor: colors.primary + "b3",
              borderColor: colors.primaryDark,
              borderWidth: 1,
              borderRadius: 8,
              maxBarThickness: 36,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "nearest",
            intersect: false,
          },
          hover: {
            mode: "nearest",
            intersect: false,
          },
          plugins: {
            legend: {
              labels: {
                color: colors.text,
                boxWidth: 12,
              },
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function (ctx) {
                  const yValue = ctx.parsed.y ?? 0;
                  if (activeMode === "income") return `Rs ${currencyTick(yValue)}`;
                  return `${yValue} Projects`;
                },
              },
            },
            zoom: {
              pan: {
                enabled: true,
                mode: "xy",
                modifierKey: "shift",
              },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                drag: {
                  enabled: true,
                  borderColor: colors.primaryDark,
                  backgroundColor: colors.primary + "22",
                },
                mode: "xy",
              },
            },
          },
          scales: {
            x: {
              ticks: { color: colors.text },
              grid: { display: false },
            },
            y: {
              ticks: {
                color: colors.muted,
                callback: activeMode === "income" ? currencyTick : undefined,
                precision: activeMode === "projects" ? 0 : undefined,
              },
              grid: { color: colors.softGrid },
            },
          },
        },
      });
    }

    function bindToggle() {
      document.querySelectorAll(".internship-toggle-btn").forEach((button) => {
        button.addEventListener("click", () => {
          activeMode = button.dataset.mode;
          document.querySelectorAll(".internship-toggle-btn").forEach((btn) => {
            btn.classList.toggle("is-active", btn === button);
          });
          drawCharts();
        });
      });
    }

    function init() {
      if (window.internshipDashboardCleanup) {
        window.internshipDashboardCleanup();
      }

      loadChartJs()
        .then(() => {
          bindToggle();
          drawCharts();

          const observer = new MutationObserver(() => drawCharts());
          observer.observe(root, { attributes: true, attributeFilter: ["class"] });

          window.internshipDashboardCleanup = function () {
            observer.disconnect();
            if (comboChart) comboChart.destroy();
            if (topProjectsChart) topProjectsChart.destroy();
            if (topMembersChart) topMembersChart.destroy();
          };
        })
        .catch(() => {
          console.error("Unable to load Chart.js");
        });
    }

    init();
  })();
</script>
