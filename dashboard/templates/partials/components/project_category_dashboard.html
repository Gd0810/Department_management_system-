{% include "tost.html" %}
<div class="w-full space-y-6 p-4 sm:p-6">
  <div class="theme-panel overflow-hidden rounded-2xl border shadow-sm transition-colors">
    <div class="theme-panel-soft border-b px-4 py-5 sm:px-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="theme-text text-xl font-semibold tracking-tight">{{ category_label }} Analytics Dashboard</h2>
          <p class="theme-muted text-sm">{{ category_label }}, project output, and team performance overview.</p>
        </div>
        <div class="relative inline-block text-left">
          <button
            type="button"
            id="reportDropdownBtn-{{ category_key }}"
            class="action-btn action-btn-view inline-flex items-center gap-2"
          >
            <iconify-icon icon="material-symbols:download-rounded" width="18" height="18"></iconify-icon>
            <span>Download Report</span>
            <iconify-icon icon="material-symbols:arrow-drop-down-rounded" width="18" height="18"></iconify-icon>
          </button>
          <div
            id="reportDropdownMenu-{{ category_key }}"
            class="theme-panel absolute right-0 z-20 mt-2 hidden min-w-[160px] rounded-xl border p-1 shadow-lg"
          >
            <a href="{% url 'project_category_report' category_key 'csv' %}" class="report-menu-item">
              <iconify-icon class="report-menu-icon" icon="vscode-icons:file-type-excel" width="20" height="20"></iconify-icon>
              <span>EXCEL Report</span>
            </a>
            <a href="{% url 'project_category_report' category_key 'pdf' %}" class="report-menu-item">
              <iconify-icon class="report-menu-icon" icon="material-icon-theme:pdf" width="20" height="20"></iconify-icon>
              <span>PDF Report</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="p-4 sm:p-6">
      <div class="grid grid-cols-1 gap-6">
        {% include "partials/components/kpi.html" %}
        {% include "partials/components/income1.html" %}
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
          {% include "partials/components/top5.html" %}
          {% include "partials/components/top51.html" %}
        </div>
        {% include "partials/components/project_listing.html" %}
      </div>
    </div>
  </div>
</div>

{{ monthly_labels|json_script:"monthly-labels" }}
{{ monthly_income|json_script:"monthly-income" }}
{{ monthly_project_count|json_script:"monthly-project-count" }}
{{ top_project_labels|json_script:"top-project-labels" }}
{{ top_project_income|json_script:"top-project-income" }}
{{ top_member_project_labels|json_script:"top-member-project-labels" }}
{{ top_member_project_values|json_script:"top-member-project-values" }}
{{ top_member_project_image_urls|json_script:"top-member-project-image-urls" }}
{{ top_member_project_initials|json_script:"top-member-project-initials" }}
{{ top_member_income_labels|json_script:"top-member-income-labels" }}
{{ top_member_income_values|json_script:"top-member-income-values" }}
{{ top_member_income_image_urls|json_script:"top-member-income-image-urls" }}
{{ top_member_income_initials|json_script:"top-member-income-initials" }}

<style>
  .category-toggle-shell { border-color: var(--panel-border); background: var(--panel-soft-bg); }
  .category-toggle-btn { border: 0; border-radius: 0.65rem; padding: 0.4rem 0.75rem; font-size: 0.78rem; font-weight: 600; color: var(--panel-muted); background: transparent; transition: all 0.2s ease; }
  .category-toggle-btn.is-active { background: linear-gradient(90deg, var(--primary-light), var(--primary-dark)); color: #fff; }
  .theme-table-head { border-top: 1px solid var(--panel-border); border-bottom: 1px solid var(--panel-border); background: var(--panel-soft-bg); color: var(--panel-text); font-weight: 600; }
  .theme-table-cell { border-bottom: 1px solid var(--panel-border); background: var(--panel-bg); color: var(--panel-text); }
  .status-chip { display: inline-flex; align-items: center; border-radius: 999px; padding: 0.15rem 0.6rem; font-size: 0.72rem; font-weight: 600; }
  .status-chip-live { color: #166534; background: #dcfce7; }
  .status-chip-open { color: #1e3a8a; background: #dbeafe; }
  .status-chip-pause { color: #92400e; background: #fef3c7; }
  .status-chip-stop { color: #991b1b; background: #fee2e2; }
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border: 1px solid var(--panel-border);
    border-radius: 0.65rem;
    padding: 0.34rem 0.72rem;
    font-size: 0.76rem;
    font-weight: 700;
    color: var(--panel-text);
    background: var(--panel-soft-bg);
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
  }
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.10);
  }
  .action-btn-view {
    background: #e0edff;
    border-color: #bfdbfe;
    color: #1d4ed8;
  }
  .action-btn-update {
    background: #e7f9ef;
    border-color: #bbf7d0;
    color: #15803d;
  }
  .action-btn-delete {
    background: #fee2e2;
    border-color: #fecaca;
    color: #b91c1c;
  }
  body.dark-theme .action-btn { box-shadow: 0 2px 10px rgba(2, 6, 23, 0.24); }
  body.dark-theme .action-btn:hover { box-shadow: 0 8px 20px rgba(2, 6, 23, 0.36); }
  body.dark-theme .action-btn-view {
    background: rgba(37, 99, 235, 0.2);
    border-color: rgba(96, 165, 250, 0.5);
    color: #93c5fd;
  }
  body.dark-theme .action-btn-update {
    background: rgba(22, 163, 74, 0.2);
    border-color: rgba(74, 222, 128, 0.45);
    color: #86efac;
  }
  body.dark-theme .action-btn-delete {
    background: rgba(220, 38, 38, 0.24);
    border-color: rgba(252, 165, 165, 0.4);
    color: #fca5a5;
  }
  .report-menu-item {
    display: flex;
    align-items: center;
    gap: 0.55rem;
    line-height: 1;
    border-radius: 0.6rem;
    padding: 0.45rem 0.65rem;
    color: var(--panel-text);
    font-size: 0.82rem;
    font-weight: 600;
    text-decoration: none;
    transition: background-color .15s ease;
  }
  .report-menu-icon {
    width: 20px;
    height: 20px;
    display: block;
    flex-shrink: 0;
  }
  .report-menu-item:hover {
    background: var(--panel-soft-bg);
  }
  .kpi-card {
    border: 1px solid var(--panel-border);
    position: relative;
    min-height: 136px;
    background: var(--panel-bg);
  }
  .kpi-fill-bg {
    position: absolute;
    inset-block: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    transition: width 1.1s cubic-bezier(.4,0,.2,1);
    border-radius: inherit;
  }
  .kpi-inner { position: relative; z-index: 1; }
  .kpi-income { border-left: 4px solid #2563eb; }
  .kpi-income .kpi-fill-bg { background: linear-gradient(105deg,#2563eb22,#06b6d410); }
  .kpi-income-share { border-left: 4px solid #06b6d4; }
  .kpi-income-share .kpi-fill-bg { background: linear-gradient(105deg,#06b6d430,#0ea5e915); }
  .kpi-count { border-left: 4px solid #16a34a; }
  .kpi-count .kpi-fill-bg { background: linear-gradient(105deg,#16a34a22,#22c55e10); }
  .kpi-count-share { border-left: 4px solid #22c55e; }
  .kpi-count-share .kpi-fill-bg { background: linear-gradient(105deg,#22c55e30,#86efac15); }
  .kpi-icon-wrap {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 10px;
  }
  .kpi-icon-income { background: rgba(37,99,235,.13); color:#2563eb; }
  .kpi-icon-income-share { background: rgba(6,182,212,.13); color:#06b6d4; }
  .kpi-icon-count { background: rgba(22,163,74,.13); color:#16a34a; }
  .kpi-icon-count-share { background: rgba(34,197,94,.13); color:#22c55e; }
  body.dark-theme .kpi-icon-income { background:rgba(37,99,235,.28); color:#60a5fa; }
  body.dark-theme .kpi-icon-income-share { background:rgba(6,182,212,.28); color:#22d3ee; }
  body.dark-theme .kpi-icon-count { background:rgba(22,163,74,.28); color:#4ade80; }
  body.dark-theme .kpi-icon-count-share { background:rgba(34,197,94,.28); color:#86efac; }
  .kpi-label {
    color: var(--panel-muted);
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1.4;
    margin: 0;
  }
  .kpi-value {
    color: var(--panel-text);
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.15;
    margin-top: 0.2rem;
    letter-spacing: -0.025em;
  }
  .kpi-unit {
    font-size: 0.9rem;
    font-weight: 600;
    opacity: 0.55;
    margin-left: 2px;
  }
  .kpi-badge {
    display: inline-block;
    border-radius: 999px;
    padding: 0.12rem 0.55rem;
    font-size: 0.7rem;
    font-weight: 700;
    flex-shrink: 0;
    white-space: nowrap;
  }
  .kpi-badge-cyan { background:rgba(6,182,212,.14); color:#0891b2; }
  .kpi-badge-green { background:rgba(34,197,94,.14); color:#16a34a; }
  body.dark-theme .kpi-badge-cyan { background:rgba(6,182,212,.28); color:#22d3ee; }
  body.dark-theme .kpi-badge-green { background:rgba(34,197,94,.28); color:#4ade80; }
  .kpi-bar-track {
    width: 100%;
    height: 5px;
    border-radius: 999px;
    background: color-mix(in srgb,var(--panel-border) 55%,transparent);
    overflow: hidden;
  }
  .kpi-bar-fill {
    height: 100%;
    border-radius: 999px;
    transition: width 1.3s cubic-bezier(.4,0,.2,1);
  }
  .kpi-bar-cyan { background: linear-gradient(90deg,#06b6d4,#2563eb); }
  .kpi-bar-green { background: linear-gradient(90deg,#22c55e,#16a34a); }
  .kpi-footnote {
    color: var(--panel-muted);
    font-size: 0.69rem;
    line-height: 1.4;
  }
</style>

<script>
  (function () {
    const categoryKey = "{{ category_key }}";
    const root = document.body;
    const monthlyLabels = JSON.parse(document.getElementById("monthly-labels").textContent || "[]");
    const monthlyIncome = JSON.parse(document.getElementById("monthly-income").textContent || "[]");
    const monthlyProjectCount = JSON.parse(document.getElementById("monthly-project-count").textContent || "[]");
    const topProjectLabels = JSON.parse(document.getElementById("top-project-labels").textContent || "[]");
    const topProjectIncome = JSON.parse(document.getElementById("top-project-income").textContent || "[]");
    const topMemberProjectLabels = JSON.parse(document.getElementById("top-member-project-labels").textContent || "[]");
    const topMemberProjectValues = JSON.parse(document.getElementById("top-member-project-values").textContent || "[]");
    const topMemberProjectImageUrls = JSON.parse(document.getElementById("top-member-project-image-urls").textContent || "[]");
    const topMemberProjectInitials = JSON.parse(document.getElementById("top-member-project-initials").textContent || "[]");
    const topMemberIncomeLabels = JSON.parse(document.getElementById("top-member-income-labels").textContent || "[]");
    const topMemberIncomeValues = JSON.parse(document.getElementById("top-member-income-values").textContent || "[]");
    const topMemberIncomeImageUrls = JSON.parse(document.getElementById("top-member-income-image-urls").textContent || "[]");
    const topMemberIncomeInitials = JSON.parse(document.getElementById("top-member-income-initials").textContent || "[]");
    let comboChart;
    let topProjectsChart;
    let topMembersChart;
    let activeMode = "projects";
    let delayedTopProjects = false;
    const avatarCanvasCache = new Map();
    const avatarImageLoading = new Set();

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (existing.dataset.loaded === "true") resolve();
          else existing.addEventListener("load", () => resolve(), { once: true });
          return;
        }
        const script = document.createElement("script");
        script.src = src;
        script.onload = () => { script.dataset.loaded = "true"; resolve(); };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function loadChartJs() {
      if (window.Chart) return Promise.resolve();
      if (window.__sharedCategoryChartLoader) return window.__sharedCategoryChartLoader;
      window.__sharedCategoryChartLoader = loadScript("https://cdn.jsdelivr.net/npm/chart.js");
      return window.__sharedCategoryChartLoader;
    }

    function palette() {
      const s = getComputedStyle(root);
      return {
        text: s.getPropertyValue("--panel-text").trim() || "#0f172a",
        muted: s.getPropertyValue("--panel-muted").trim() || "#475569",
        primary: s.getPropertyValue("--primary-light").trim() || "#6366f1",
        primaryDark: s.getPropertyValue("--primary-dark").trim() || "#4f46e5",
        border: s.getPropertyValue("--panel-border").trim() || "#cbd5e1",
        softGrid: root.classList.contains("dark-theme") ? "rgba(148,163,184,.2)" : "rgba(100,116,139,.18)",
      };
    }

    function money(v) { return Number(v).toLocaleString("en-IN"); }
    function hexToRgba(hex, alpha) {
      const clean = (hex || "").replace("#", "");
      const normalized = clean.length === 3
        ? clean.split("").map((c) => c + c).join("")
        : clean;
      const r = parseInt(normalized.substring(0, 2), 16) || 99;
      const g = parseInt(normalized.substring(2, 4), 16) || 102;
      const b = parseInt(normalized.substring(4, 6), 16) || 241;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function fallbackAvatar(initials) {
      const key = `fallback:${initials || "NA"}`;
      if (avatarCanvasCache.has(key)) return avatarCanvasCache.get(key);
      const canvas = document.createElement("canvas");
      canvas.width = 34;
      canvas.height = 34;
      const ctx = canvas.getContext("2d");
      if (ctx) {
        ctx.fillStyle = "#dbeafe";
        ctx.strokeStyle = "#bfdbfe";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(17, 17, 15, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        ctx.fillStyle = "#1d4ed8";
        ctx.font = "700 12px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText((initials || "NA").toUpperCase().slice(0, 2), 17, 17);
      }
      avatarCanvasCache.set(key, canvas);
      return canvas;
    }

    function resolveAvatarCanvas(url, initials) {
      const key = url ? `img:${url}` : `fallback:${initials || "NA"}`;
      if (avatarCanvasCache.has(key)) return avatarCanvasCache.get(key);
      const placeholder = fallbackAvatar(initials);
      if (!url || avatarImageLoading.has(url)) return placeholder;

      avatarImageLoading.add(url);
      const image = new Image();
      image.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = 34;
        canvas.height = 34;
        const ctx = canvas.getContext("2d");
        if (ctx) {
          ctx.save();
          ctx.beginPath();
          ctx.arc(17, 17, 15, 0, Math.PI * 2);
          ctx.closePath();
          ctx.clip();
          ctx.drawImage(image, 2, 2, 30, 30);
          ctx.restore();
          ctx.strokeStyle = "#ffffff";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(17, 17, 15, 0, Math.PI * 2);
          ctx.stroke();
        }
        avatarCanvasCache.set(key, canvas);
        avatarImageLoading.delete(url);
        if (topMembersChart) topMembersChart.update("none");
      };
      image.onerror = () => {
        avatarImageLoading.delete(url);
      };
      image.src = url;
      return placeholder;
    }

    const memberAvatarPlugin = {
      id: "memberAvatarPlugin",
      afterDatasetsDraw(chart) {
        if (!chart || chart.canvas.id !== `topMembersChart-${categoryKey}`) return;
        const urls = activeMode === "income" ? topMemberIncomeImageUrls : topMemberProjectImageUrls;
        const initials = activeMode === "income" ? topMemberIncomeInitials : topMemberProjectInitials;
        const datasetMeta = chart.getDatasetMeta(0);
        if (!datasetMeta || !datasetMeta.data) return;
        const ctx = chart.ctx;
        datasetMeta.data.forEach((bar, index) => {
          const avatar = resolveAvatarCanvas(urls[index] || "", initials[index] || "");
          const x = bar.x - 17;
          const y = bar.y - 40;
          ctx.drawImage(avatar, x, y, 34, 34);
        });
      },
    };

    function drawCharts() {
      delayedTopProjects = false;
      const colors = palette();
      const comboCtx = document.getElementById(`incomeProjectsChart-${categoryKey}`);
      const projectsCtx = document.getElementById(`topProjectsChart-${categoryKey}`);
      const membersCtx = document.getElementById(`topMembersChart-${categoryKey}`);
      if (!comboCtx || !projectsCtx || !membersCtx) return;

      if (comboChart) comboChart.destroy();
      if (topProjectsChart) topProjectsChart.destroy();
      if (topMembersChart) topMembersChart.destroy();

      comboChart = new Chart(comboCtx, {
        type: "bar",
        data: {
          labels: monthlyLabels,
          datasets: [
            { type: "bar", label: "Total Project Count", data: monthlyProjectCount, yAxisID: "projects", backgroundColor: colors.primary + "99", borderColor: colors.primary, borderWidth: 1, borderRadius: 8, maxBarThickness: 24 },
            {
              type: "line",
              label: "Total Income (Rs)",
              data: monthlyIncome,
              yAxisID: "income",
              borderColor: colors.primaryDark,
              backgroundColor: function (ctx) {
                const chart = ctx.chart;
                const area = chart.chartArea;
                if (!area) return hexToRgba(colors.primaryDark, 0.2);
                const gradient = chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
                gradient.addColorStop(0, hexToRgba(colors.primaryDark, 0.34));
                gradient.addColorStop(0.55, hexToRgba(colors.primaryDark, 0.14));
                gradient.addColorStop(1, hexToRgba(colors.primaryDark, 0));
                return gradient;
              },
              fill: "origin",
              borderWidth: 2.6,
              pointRadius: 3.5,
              pointHoverRadius: 5,
              pointBackgroundColor: colors.primaryDark,
              pointBorderWidth: 0,
              tension: 0.42,
              cubicInterpolationMode: "monotone",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1100,
            easing: "easeOutCubic",
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 90) + (ctx.datasetIndex * 120) : 0),
          },
          plugins: {
            legend: { labels: { color: colors.text } },
            tooltip: { callbacks: { label: (ctx) => ctx.dataset.yAxisID === "income" ? `${ctx.dataset.label}: Rs ${money(ctx.parsed.y || 0)}` : `${ctx.dataset.label}: ${ctx.parsed.y || 0}` } },
          },
          scales: {
            x: { ticks: { color: colors.muted }, grid: { color: colors.softGrid } },
            projects: { position: "left", ticks: { color: colors.muted, precision: 0 }, grid: { color: colors.softGrid } },
            income: { position: "right", ticks: { color: colors.muted, callback: money }, grid: { drawOnChartArea: false } },
          },
        },
      });

      topProjectsChart = new Chart(projectsCtx, {
        type: "bar",
        data: { labels: topProjectLabels, datasets: [{ label: "Total Income (Rs)", data: topProjectIncome, backgroundColor: [colors.primary + "cc", colors.primaryDark + "cc", "#0ea5e9cc", "#10b981cc", "#f59e0bcc"], borderColor: colors.border, borderWidth: 1, borderRadius: 8 }] },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            onComplete: () => {
              delayedTopProjects = true;
            },
          },
          animations: {
            x: {
              from: 0,
              easing: "easeInOutElastic",
              duration: 1200,
              delay: (context) => {
                let delay = 0;
                if (context.type === "data" && !delayedTopProjects) {
                  delay = context.dataIndex * 300 + context.datasetIndex * 100;
                }
                return delay;
              },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => `Rs ${money(ctx.parsed.x || 0)}` } },
          },
          scales: {
            x: { stacked: true, ticks: { color: colors.muted, callback: money }, grid: { color: colors.softGrid } },
            y: { stacked: true, ticks: { color: colors.text }, grid: { display: false } },
          },
        },
      });

      const labels = activeMode === "income" ? topMemberIncomeLabels : topMemberProjectLabels;
      const values = activeMode === "income" ? topMemberIncomeValues : topMemberProjectValues;
      const label = activeMode === "income" ? "Income Earned (Rs)" : "Project Count";
      topMembersChart = new Chart(membersCtx, {
        type: "bar",
        data: { labels, datasets: [{ label, data: values, backgroundColor: colors.primary + "b3", borderColor: colors.primaryDark, borderWidth: 1, borderRadius: 8, maxBarThickness: 36 }] },
        plugins: [memberAvatarPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animations: {
            y: {
              easing: "easeInOutElastic",
              from: (ctx) => {
                if (ctx.type === "data") {
                  if (ctx.mode === "default" && !ctx.dropped) {
                    ctx.dropped = true;
                    return 0;
                  }
                }
              },
            },
          },
          layout: { padding: { top: 44 } },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => activeMode === "income" ? `Rs ${money(ctx.parsed.y || 0)}` : `${ctx.parsed.y || 0} Projects` } },
          },
          scales: {
            x: { ticks: { color: colors.text }, grid: { display: false } },
            y: { ticks: { color: colors.muted, callback: activeMode === "income" ? money : undefined, precision: activeMode === "projects" ? 0 : undefined }, grid: { color: colors.softGrid } },
          },
        },
      });
    }

    function bindToggle() {
      document.querySelectorAll(`.category-toggle-btn[data-category="${categoryKey}"]`).forEach((button) => {
        button.addEventListener("click", () => {
          activeMode = button.dataset.mode;
          document.querySelectorAll(`.category-toggle-btn[data-category="${categoryKey}"]`).forEach((btn) => btn.classList.toggle("is-active", btn === button));
          drawCharts();
        });
      });
    }

    function init() {
      if (window.categoryDashboardCleanup) window.categoryDashboardCleanup();
      loadChartJs().then(() => {
        bindToggle();
        drawCharts();
        const reportBtn = document.getElementById(`reportDropdownBtn-${categoryKey}`);
        const reportMenu = document.getElementById(`reportDropdownMenu-${categoryKey}`);
        const closeReportMenu = (evt) => {
          if (!reportBtn || !reportMenu) return;
          if (evt && (reportBtn.contains(evt.target) || reportMenu.contains(evt.target))) return;
          reportMenu.classList.add("hidden");
        };
        if (reportBtn && reportMenu) {
          reportBtn.addEventListener("click", (evt) => {
            evt.stopPropagation();
            reportMenu.classList.toggle("hidden");
          });
          document.addEventListener("click", closeReportMenu);
        }
        const observer = new MutationObserver(() => drawCharts());
        observer.observe(root, { attributes: true, attributeFilter: ["class"] });
        window.categoryDashboardCleanup = function () {
          document.removeEventListener("click", closeReportMenu);
          observer.disconnect();
          if (comboChart) comboChart.destroy();
          if (topProjectsChart) topProjectsChart.destroy();
          if (topMembersChart) topMembersChart.destroy();
        };
      });
    }

    init();
  })();
</script>
