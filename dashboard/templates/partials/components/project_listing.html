<div class="theme-panel rounded-2xl border p-4 sm:p-5">
      <div class="mb-4 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
        <h3 class="theme-text text-base font-semibold">{{ category_label }} Project Listing</h3>
        <div class="flex flex-wrap items-center gap-2">
          <div class="relative inline-block text-left">
            <button
              type="button"
              id="listingReportDropdownBtn-{{ category_key }}"
              class="action-btn action-btn-view inline-flex items-center gap-2"
            >
              <iconify-icon icon="material-symbols:download-rounded" width="16" height="16"></iconify-icon>
              <span>Listing Report</span>
              <iconify-icon icon="material-symbols:arrow-drop-down-rounded" width="18" height="18"></iconify-icon>
            </button>
            <div
              id="listingReportDropdownMenu-{{ category_key }}"
              class="theme-panel absolute right-0 z-20 mt-2 hidden min-w-[170px] rounded-xl border p-1 shadow-lg"
            >
              <a id="listingReportExcelLink-{{ category_key }}" href="#" class="report-menu-item">
                <iconify-icon class="report-menu-icon" icon="vscode-icons:file-type-excel" width="20" height="20"></iconify-icon>
                <span>EXCEL Report</span>
              </a>
              <a id="listingReportPdfLink-{{ category_key }}" href="#" class="report-menu-item">
                <iconify-icon class="report-menu-icon" icon="material-icon-theme:pdf" width="20" height="20"></iconify-icon>
                <span>PDF Report</span>
              </a>
            </div>
          </div>
          <button
            type="button"
            class="action-btn action-btn-update"
            hx-get="{% url 'add_project' %}"
            hx-target="#content"
            hx-swap="innerHTML"
          >
            <iconify-icon icon="material-symbols:add-rounded" width="16" height="16"></iconify-icon>
            <span>Add New Project</span>
          </button>
        </div>
      </div>

      <div class="mb-4 grid grid-cols-1 gap-2 md:grid-cols-2 xl:grid-cols-5">
        <div class="xl:col-span-2">
          <input
            id="projectSearch-{{ category_key }}"
            type="search"
            placeholder="Search project name..."
            class="theme-input w-full rounded-xl border px-3 py-2 text-sm outline-none transition"
          >
        </div>
        <div>
          <input
            id="projectMonth-{{ category_key }}"
            type="month"
            class="theme-input w-full rounded-xl border px-3 py-2 text-sm outline-none transition"
          >
        </div>
        <div>
          <div id="projectYearWrap-{{ category_key }}" class="relative">
            <input id="projectYear-{{ category_key }}" type="hidden" value="">
            <button
              type="button"
              id="projectYearBtn-{{ category_key }}"
              class="theme-input flex w-full items-center justify-between rounded-xl border px-3 py-2 text-sm outline-none transition"
            >
              <span id="projectYearBtnLabel-{{ category_key }}">All Years</span>
              <iconify-icon icon="material-symbols:arrow-drop-down-rounded" width="20" height="20"></iconify-icon>
            </button>
            <div
              id="projectYearMenu-{{ category_key }}"
              class="theme-panel absolute left-0 right-0 top-[calc(100%+6px)] z-20 hidden max-h-44 overflow-y-auto rounded-xl border py-1 shadow-lg"
            >
              <button type="button" class="project-year-option block w-full px-3 py-2 text-left text-sm" data-year="">All Years</button>
            </div>
          </div>
        </div>
        <div class="flex gap-2">
          <select id="projectStatus-{{ category_key }}" class="theme-input w-full rounded-xl border px-3 py-2 text-sm outline-none transition">
            <option value="">All Status</option>
            <option value="started">Started</option>
            <option value="ongoing">Ongoing</option>
            <option value="on_hold">On Hold</option>
            <option value="canceled">Canceled</option>
            <option value="finished">Finished</option>
          </select>
          <button type="button" id="projectFilterClear-{{ category_key }}" class="action-btn">Clear</button>
        </div>
      </div>

      <div class="overflow-x-auto" id="projectListingScroll-{{ category_key }}" style="max-height: 430px;">
        <table class="w-full min-w-[680px] border-separate border-spacing-0 text-sm">
          <thead>
            <tr>
              <th class="theme-table-head rounded-tl-xl px-4 py-3 text-left">Project Title</th>
              <th class="theme-table-head px-4 py-3 text-left">Status</th>
              <th class="theme-table-head px-4 py-3 text-left">Start Date</th>
              <th class="theme-table-head rounded-tr-xl px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="projectListingBody-{{ category_key }}"></tbody>
          <tbody id="projectListingEmpty-{{ category_key }}" class="hidden">
            <tr>
              <td class="theme-table-cell px-4 py-4 text-center theme-muted" colspan="4">No {{ category_label|lower }} projects available.</td>
            </tr>
          </tbody>
        </table>
      </div>
</div>

<script>
  (function () {
    const categoryKey = "{{ category_key }}";
    const scrollWrap = document.getElementById(`projectListingScroll-${categoryKey}`);
    const body = document.getElementById(`projectListingBody-${categoryKey}`);
    const emptyBody = document.getElementById(`projectListingEmpty-${categoryKey}`);
    const searchInput = document.getElementById(`projectSearch-${categoryKey}`);
    const monthInput = document.getElementById(`projectMonth-${categoryKey}`);
    const yearInput = document.getElementById(`projectYear-${categoryKey}`);
    const yearWrap = document.getElementById(`projectYearWrap-${categoryKey}`);
    const yearBtn = document.getElementById(`projectYearBtn-${categoryKey}`);
    const yearBtnLabel = document.getElementById(`projectYearBtnLabel-${categoryKey}`);
    const yearMenu = document.getElementById(`projectYearMenu-${categoryKey}`);
    const statusInput = document.getElementById(`projectStatus-${categoryKey}`);
    const clearBtn = document.getElementById(`projectFilterClear-${categoryKey}`);
    const listingReportBtn = document.getElementById(`listingReportDropdownBtn-${categoryKey}`);
    const listingReportMenu = document.getElementById(`listingReportDropdownMenu-${categoryKey}`);
    const listingReportExcelLink = document.getElementById(`listingReportExcelLink-${categoryKey}`);
    const listingReportPdfLink = document.getElementById(`listingReportPdfLink-${categoryKey}`);
    if (!scrollWrap || !body || !emptyBody || !searchInput || !monthInput || !yearInput || !yearWrap || !yearBtn || !yearBtnLabel || !yearMenu || !statusInput || !clearBtn || !listingReportBtn || !listingReportMenu || !listingReportExcelLink || !listingReportPdfLink) return;

    const apiUrl = "{% url 'category_projects_api' '__category__' %}".replace("__category__", categoryKey);
    const listingReportBase = "{% url 'project_listing_report' '__category__' '__format__' %}".replace("__category__", categoryKey);
    const pageSize = 7;
    let offset = 0;
    let hasMore = true;
    let isLoading = false;
    let searchDebounce;
    let yearOptionsReady = false;

    function buildYearOptions(years) {
      yearMenu.innerHTML = `<button type="button" class="project-year-option block w-full px-3 py-2 text-left text-sm" data-year="">All Years</button>`;
      const normalized = Array.from(new Set((years || []).map((y) => Number(y)).filter((y) => Number.isInteger(y) && y > 0)))
        .sort((a, b) => b - a);
      normalized.forEach((yearNumber) => {
        const optionBtn = document.createElement("button");
        optionBtn.type = "button";
        optionBtn.className = "project-year-option block w-full px-3 py-2 text-left text-sm";
        optionBtn.dataset.year = String(yearNumber);
        optionBtn.textContent = String(yearNumber);
        yearMenu.appendChild(optionBtn);
      });
      yearOptionsReady = true;
    }

    function setYearValue(yearValue) {
      yearInput.value = yearValue;
      yearBtnLabel.textContent = yearValue || "All Years";
      resetAndLoad();
    }

    function toggleYearMenu(forceOpen) {
      const shouldOpen = typeof forceOpen === "boolean" ? forceOpen : yearMenu.classList.contains("hidden");
      yearMenu.classList.toggle("hidden", !shouldOpen);
    }

    function statusClass(status) {
      if (status === "finished") return "status-chip-open";
      if (status === "on_hold") return "status-chip-pause";
      if (status === "canceled") return "status-chip-stop";
      return "status-chip-live";
    }

    function rowMarkup(project) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="theme-table-cell px-4 py-3">${project.title}</td>
        <td class="theme-table-cell px-4 py-3">
          <span class="status-chip ${statusClass(project.status)}">${project.status_display}</span>
        </td>
        <td class="theme-table-cell px-4 py-3">${project.start_date}</td>
        <td class="theme-table-cell px-4 py-3">
          <div class="flex flex-wrap gap-2">
            <button type="button" class="action-btn action-btn-view view-project-btn" data-view-url="${project.view_url || ''}">
              <iconify-icon icon="material-symbols:visibility-rounded" width="16" height="16"></iconify-icon>
              <span>View</span>
            </button>
            <button type="button" class="action-btn action-btn-update update-project-btn" data-update-url="${project.update_url || ''}">
              <iconify-icon icon="material-symbols:edit-rounded" width="16" height="16"></iconify-icon>
              <span>Update</span>
            </button>
            <button type="button" class="action-btn action-btn-delete delete-project-btn" data-delete-url="${project.delete_url || ''}">
              <iconify-icon icon="material-symbols:delete-rounded" width="16" height="16"></iconify-icon>
              <span>Delete</span>
            </button>
          </div>
        </td>
      `;
      const viewBtn = tr.querySelector(".view-project-btn");
      if (viewBtn) {
        viewBtn.addEventListener("click", function () {
          const viewUrl = this.dataset.viewUrl;
          if (!viewUrl || !window.htmx) return;
          window.htmx.ajax("GET", viewUrl, { target: "#content", swap: "innerHTML" });
        });
      }
      const updateBtn = tr.querySelector(".update-project-btn");
      if (updateBtn) {
        updateBtn.addEventListener("click", function () {
          const updateUrl = this.dataset.updateUrl;
          if (!updateUrl || !window.htmx) return;
          window.htmx.ajax("GET", updateUrl, { target: "#content", swap: "innerHTML" });
        });
      }
      const deleteBtn = tr.querySelector(".delete-project-btn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", function () {
          const deleteUrl = this.dataset.deleteUrl;
          if (!deleteUrl || !window.htmx) return;
          if (!window.confirm("Are you sure you want to delete this project?")) return;
          window.htmx.ajax("POST", deleteUrl, {
            target: "#content",
            swap: "innerHTML",
            headers: {
              "X-CSRFToken": getCsrfToken(),
            },
          });
        });
      }
      return tr;
    }

    function getCsrfToken() {
      const cookieValue = document.cookie
        .split("; ")
        .find((row) => row.startsWith("csrftoken="));
      return cookieValue ? decodeURIComponent(cookieValue.split("=")[1]) : "";
    }

    function buildFilterQuery() {
      const params = new URLSearchParams();
      const q = searchInput.value.trim();
      const month = monthInput.value;
      const year = yearInput.value.trim();
      const status = statusInput.value;
      if (q) params.set("q", q);
      if (month) params.set("month", month);
      if (year) params.set("year", year);
      if (status) params.set("status", status);
      return params.toString();
    }

    function updateListingReportLinks() {
      const filterQuery = buildFilterQuery();
      const excelUrl = `${listingReportBase.replace("__format__", "csv")}${filterQuery ? `?${filterQuery}` : ""}`;
      const pdfUrl = `${listingReportBase.replace("__format__", "pdf")}${filterQuery ? `?${filterQuery}` : ""}`;
      listingReportExcelLink.href = excelUrl;
      listingReportPdfLink.href = pdfUrl;
    }

    function resetAndLoad() {
      offset = 0;
      hasMore = true;
      body.innerHTML = "";
      emptyBody.classList.add("hidden");
      loadNextPage();
    }

    async function loadNextPage() {
      if (isLoading || !hasMore) return;
      isLoading = true;

      try {
        const filterQuery = buildFilterQuery();
        const queryPrefix = filterQuery ? `${filterQuery}&` : "";
        const response = await fetch(`${apiUrl}?${queryPrefix}offset=${offset}&limit=${pageSize}`, {
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        if (!response.ok) throw new Error("Request failed");
        const data = await response.json();
        if (!yearOptionsReady) buildYearOptions(data.available_years || []);
        const rows = Array.isArray(data.projects) ? data.projects : [];
        if (!rows.length && offset === 0) {
          emptyBody.classList.remove("hidden");
        } else {
          emptyBody.classList.add("hidden");
        }

        rows.forEach((project) => body.appendChild(rowMarkup(project)));
        offset = Number(data.next_offset || (offset + rows.length));
        hasMore = Boolean(data.has_more);
      } catch (error) {
      } finally {
        isLoading = false;
      }
    }

    function onScroll() {
      const threshold = 120;
      const nearBottom = scrollWrap.scrollTop + scrollWrap.clientHeight >= scrollWrap.scrollHeight - threshold;
      if (nearBottom) loadNextPage();
    }

    scrollWrap.addEventListener("scroll", onScroll);
    searchInput.addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(resetAndLoad, 300);
      updateListingReportLinks();
    });
    monthInput.addEventListener("change", () => {
      resetAndLoad();
      updateListingReportLinks();
    });
    statusInput.addEventListener("change", () => {
      resetAndLoad();
      updateListingReportLinks();
    });
    yearBtn.addEventListener("click", () => {
      toggleYearMenu();
    });
    yearMenu.addEventListener("click", (event) => {
      const option = event.target.closest(".project-year-option");
      if (!option) return;
      toggleYearMenu(false);
      setYearValue(option.dataset.year || "");
      updateListingReportLinks();
    });
    document.addEventListener("click", (event) => {
      if (!yearWrap.contains(event.target)) toggleYearMenu(false);
      if (!listingReportMenu.contains(event.target) && !listingReportBtn.contains(event.target)) {
        listingReportMenu.classList.add("hidden");
      }
    });
    listingReportBtn.addEventListener("click", (event) => {
      event.stopPropagation();
      updateListingReportLinks();
      listingReportMenu.classList.toggle("hidden");
    });
    listingReportMenu.addEventListener("click", () => {
      listingReportMenu.classList.add("hidden");
    });
    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      monthInput.value = "";
      yearInput.value = "";
      yearBtnLabel.textContent = "All Years";
      statusInput.value = "";
      resetAndLoad();
      updateListingReportLinks();
    });
    updateListingReportLinks();
    loadNextPage();
  })();
</script>
