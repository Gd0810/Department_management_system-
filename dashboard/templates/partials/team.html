{% include "tost.html" %}
<section class="w-full space-y-6 p-4 sm:p-6">
  <div class="theme-panel overflow-hidden rounded-2xl border shadow-sm">
    <div class="theme-panel-soft border-b px-4 py-5 sm:px-6">
      <h2 class="theme-text text-xl font-semibold tracking-tight">Team Dashboard</h2>
      <p class="theme-muted text-sm">Active team analytics and worker performance overview.</p>
    </div>

    <div class="space-y-6 p-4 sm:p-6">
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
        <div class="kpi-card rounded-2xl border p-4">
          <p class="kpi-label">Total Staff Count</p>
          <p class="kpi-value">{{ staff_count }}</p>
        </div>
        <div class="kpi-card rounded-2xl border p-4">
          <p class="kpi-label">Total Intern Count</p>
          <p class="kpi-value">{{ intern_count }}</p>
        </div>
        <div class="kpi-card rounded-2xl border p-4">
          <p class="kpi-label">Workers / Total Projects (Average %)</p>
          <p class="kpi-value">{{ workers_project_avg_pct|floatformat:2 }}%</p>
        </div>
        <div class="kpi-card rounded-2xl border p-4">
          <p class="kpi-label">Workers / Total Income (Average %)</p>
          <p class="kpi-value">{{ workers_income_avg_pct|floatformat:6 }}%</p>
        </div>
      </div>

      <div class="theme-panel rounded-2xl border p-4 sm:p-5">
        <h3 class="theme-text mb-3 text-base font-semibold">Per Person Income vs Project Count</h3>
        <div class="relative h-[350px] w-full">
          <canvas id="workerIncomeProjectsChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <div class="theme-panel rounded-2xl border p-4 sm:p-5">
          <h3 class="theme-text mb-3 text-base font-semibold">Project Status Responsibility</h3>
          <div class="relative h-[320px] w-full">
            <canvas id="workerStatusChart"></canvas>
          </div>
        </div>
        <div class="theme-panel rounded-2xl border p-4 sm:p-5">
          <h3 class="theme-text mb-3 text-base font-semibold">Productivity vs Income vs Experience</h3>
          <div class="relative h-[320px] w-full">
            <canvas id="workerBubbleChart"></canvas>
          </div>
        </div>
      </div>

      <div class="theme-panel rounded-2xl border p-4 sm:p-5">
        <h3 class="theme-text mb-3 text-base font-semibold">Worker Listing</h3>
        <div class="overflow-x-auto">
          <table class="w-full min-w-[850px] border-separate border-spacing-0 text-sm">
            <thead>
              <tr>
                <th class="theme-table-head rounded-tl-xl px-4 py-3 text-left">Name</th>
                <th class="theme-table-head px-4 py-3 text-left">Email</th>
                <th class="theme-table-head px-4 py-3 text-left">Date Of Join</th>
                <th class="theme-table-head px-4 py-3 text-left">Posting</th>
                <th class="theme-table-head rounded-tr-xl px-4 py-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for worker in workers %}
                <tr>
                  <td class="theme-table-cell px-4 py-3">
                    <div class="flex items-center gap-3">
                      {% if worker.image_url %}
                        <img src="{{ worker.image_url }}" alt="{{ worker.name }}" class="h-9 w-9 rounded-full object-cover">
                      {% else %}
                        <div class="avatar-fallback">{{ worker.initials }}</div>
                      {% endif %}
                      <span class="font-semibold">{{ worker.name }}</span>
                    </div>
                  </td>
                  <td class="theme-table-cell px-4 py-3">{{ worker.email|default:"-" }}</td>
                  <td class="theme-table-cell px-4 py-3">{{ worker.date_of_join|date:"Y-m-d" }}</td>
                  <td class="theme-table-cell px-4 py-3">{{ worker.posting }}</td>
                  <td class="theme-table-cell px-4 py-3">
                    <div class="flex flex-wrap gap-2">
                      <button type="button" class="action-btn action-btn-view" onclick="alert('Worker view coming soon')">
                        <iconify-icon icon="material-symbols:visibility-rounded" width="16" height="16"></iconify-icon>
                        <span>View</span>
                      </button>
                      <button type="button" class="action-btn action-btn-update" onclick="alert('Worker update coming soon')">
                        <iconify-icon icon="material-symbols:edit-rounded" width="16" height="16"></iconify-icon>
                        <span>Update</span>
                      </button>
                      <button type="button" class="action-btn action-btn-delete" onclick="alert('Worker delete coming soon')">
                        <iconify-icon icon="material-symbols:delete-rounded" width="16" height="16"></iconify-icon>
                        <span>Delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td class="theme-table-cell px-4 py-4 text-center theme-muted" colspan="5">No active workers available.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

{{ worker_labels|json_script:"worker-labels" }}
{{ worker_income_values|json_script:"worker-income-values" }}
{{ worker_project_values|json_script:"worker-project-values" }}
{{ worker_experience_values|json_script:"worker-experience-values" }}
{{ worker_type_values|json_script:"worker-type-values" }}
{{ worker_finished_values|json_script:"worker-finished-values" }}
{{ worker_ongoing_values|json_script:"worker-ongoing-values" }}
{{ worker_on_hold_values|json_script:"worker-on-hold-values" }}
{{ worker_canceled_values|json_script:"worker-canceled-values" }}

<style>
  .kpi-card { border-color: var(--panel-border); background: var(--panel-bg); }
  .kpi-label { color: var(--panel-muted); font-size: .75rem; font-weight: 600; }
  .kpi-value { color: var(--panel-text); font-size: 1.5rem; font-weight: 800; margin-top: .25rem; }
  .theme-table-head { border-top: 1px solid var(--panel-border); border-bottom: 1px solid var(--panel-border); background: var(--panel-soft-bg); color: var(--panel-text); font-weight: 600; }
  .theme-table-cell { border-bottom: 1px solid var(--panel-border); background: var(--panel-bg); color: var(--panel-text); }
  .avatar-fallback {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: .76rem;
    font-weight: 700;
    color: #1d4ed8;
    background: #dbeafe;
    border: 1px solid #bfdbfe;
    text-transform: uppercase;
  }
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border: 1px solid var(--panel-border);
    border-radius: 0.65rem;
    padding: 0.34rem 0.72rem;
    font-size: 0.76rem;
    font-weight: 700;
    color: var(--panel-text);
    background: var(--panel-soft-bg);
    transition: all 0.2s ease;
  }
  .action-btn-view { background: #e0edff; border-color: #bfdbfe; color: #1d4ed8; }
  .action-btn-update { background: #e7f9ef; border-color: #bbf7d0; color: #15803d; }
  .action-btn-delete { background: #fee2e2; border-color: #fecaca; color: #b91c1c; }
</style>

<script>
  (function () {
    const labels = JSON.parse(document.getElementById("worker-labels").textContent || "[]");
    const incomeValues = JSON.parse(document.getElementById("worker-income-values").textContent || "[]");
    const projectValues = JSON.parse(document.getElementById("worker-project-values").textContent || "[]");
    const experienceValues = JSON.parse(document.getElementById("worker-experience-values").textContent || "[]");
    const workerTypes = JSON.parse(document.getElementById("worker-type-values").textContent || "[]");
    const finishedValues = JSON.parse(document.getElementById("worker-finished-values").textContent || "[]");
    const ongoingValues = JSON.parse(document.getElementById("worker-ongoing-values").textContent || "[]");
    const onHoldValues = JSON.parse(document.getElementById("worker-on-hold-values").textContent || "[]");
    const canceledValues = JSON.parse(document.getElementById("worker-canceled-values").textContent || "[]");

    const incomeProjectCtx = document.getElementById("workerIncomeProjectsChart");
    const statusCtx = document.getElementById("workerStatusChart");
    const bubbleCtx = document.getElementById("workerBubbleChart");
    if (!incomeProjectCtx || !statusCtx || !bubbleCtx) return;

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (existing.dataset.loaded === "true") resolve();
          else existing.addEventListener("load", () => resolve(), { once: true });
          return;
        }
        const script = document.createElement("script");
        script.src = src;
        script.onload = () => { script.dataset.loaded = "true"; resolve(); };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function money(v) { return Number(v || 0).toLocaleString("en-IN"); }
    function detectDarkMode() {
      const root = document.documentElement;
      const body = document.body;
      return root.classList.contains("dark-theme")
        || body.classList.contains("dark-theme")
        || root.classList.contains("dark")
        || body.classList.contains("dark")
        || root.getAttribute("data-theme") === "dark"
        || body.getAttribute("data-theme") === "dark";
    }

    function drawCharts() {
      const isDarkMode = detectDarkMode();
      const axisTextColor = isDarkMode ? "#ffffff" : "#6b7280";
      const axisTitleColor = isDarkMode ? "#ffffff" : "#374151";
      const axisGridColor = isDarkMode ? "rgba(255,255,255,0.15)" : "rgba(107,114,128,0.12)";
      const totalLineColor = isDarkMode ? "#ffffff" : "#111827";

      if (window.teamChart1) window.teamChart1.destroy();
      if (window.teamChart2) window.teamChart2.destroy();
      if (window.teamChart3) window.teamChart3.destroy();

      window.teamChart1 = new Chart(incomeProjectCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Per Person Income (Rs)",
              data: incomeValues,
              yAxisID: "income",
              borderColor: "#7072FF",
              backgroundColor: "rgba(112, 114, 255, 0.15)",
              tension: 0.35,
              fill: true,
              pointRadius: 3,
            },
            {
              label: "Per Person Project Count",
              data: projectValues,
              yAxisID: "projects",
              borderColor: "#33C494",
              backgroundColor: "rgba(51, 196, 148, 0.15)",
              tension: 0.35,
              fill: true,
              pointRadius: 3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1200,
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 80) + (ctx.datasetIndex * 120) : 0),
          },
          scales: {
            x: {
              ticks: { color: axisTextColor },
              grid: { color: axisGridColor },
            },
            income: {
              position: "left",
              ticks: { color: axisTextColor, callback: (v) => money(v) },
              title: { display: true, text: "Income (Rs)", color: axisTitleColor },
              grid: { color: axisGridColor },
            },
            projects: {
              position: "right",
              title: { display: true, text: "Project Count", color: axisTitleColor },
              grid: { drawOnChartArea: false },
              ticks: { color: axisTextColor, precision: 0 },
            },
          },
        },
      });

      window.teamChart2 = new Chart(statusCtx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Finished",
              data: finishedValues,
              stack: "status",
              backgroundColor: "rgba(51, 196, 148, 0.85)",
              borderColor: "#33C494",
              borderWidth: 1,
            },
            {
              label: "Ongoing",
              data: ongoingValues,
              stack: "status",
              backgroundColor: "rgba(112, 114, 255, 0.85)",
              borderColor: "#7072FF",
              borderWidth: 1,
            },
            {
              label: "On Hold",
              data: onHoldValues,
              stack: "status",
              backgroundColor: "rgba(245, 158, 11, 0.85)",
              borderColor: "#f59e0b",
              borderWidth: 1,
            },
            {
              label: "Cancelled",
              data: canceledValues,
              stack: "status",
              backgroundColor: "rgba(239, 68, 68, 0.85)",
              borderColor: "#ef4444",
              borderWidth: 1,
            },
            {
              type: "line",
              label: "Total Assigned Projects",
              data: labels.map((_, idx) => Number(finishedValues[idx] || 0) + Number(ongoingValues[idx] || 0) + Number(onHoldValues[idx] || 0) + Number(canceledValues[idx] || 0)),
              yAxisID: "count",
              borderColor: totalLineColor,
              backgroundColor: totalLineColor,
              pointRadius: 3,
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1300,
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 70) + (ctx.datasetIndex * 110) : 0),
          },
          animations: {
            y: {
              easing: "easeInOutElastic",
              from: 0,
              duration: 1400,
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y || 0}`,
              },
            },
          },
          scales: {
            x: {
              stacked: true,
              ticks: { color: axisTextColor, maxRotation: 40, minRotation: 0 },
              title: { display: true, text: "Worker", color: axisTitleColor },
              grid: { color: axisGridColor },
            },
            count: {
              beginAtZero: true,
              stacked: true,
              ticks: {
                color: axisTextColor,
                precision: 0,
              },
              title: {
                display: true,
                text: "Project Count",
                color: axisTitleColor,
              },
              grid: { color: axisGridColor },
            },
          },
        },
      });

      const staffPoints = [];
      const internPoints = [];
      for (let i = 0; i < labels.length; i += 1) {
        const point = {
          x: Number(projectValues[i] || 0),
          y: Number(incomeValues[i] || 0),
          r: Math.max(5, Math.min(24, Math.sqrt(Number(experienceValues[i] || 0)))),
          workerName: labels[i],
          expDays: Number(experienceValues[i] || 0),
        };
        if ((workerTypes[i] || "").toLowerCase() === "staff") staffPoints.push(point);
        else internPoints.push(point);
      }

      window.teamChart3 = new Chart(bubbleCtx, {
        type: "bubble",
        data: {
          datasets: [
            {
              label: "Staff",
              data: staffPoints,
              borderColor: "#7072FF",
              backgroundColor: "rgba(112, 114, 255, 0.35)",
            },
            {
              label: "Intern",
              data: internPoints,
              borderColor: "#33C494",
              backgroundColor: "rgba(51, 196, 148, 0.35)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1200,
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 90) + (ctx.datasetIndex * 120) : 0),
          },
          animations: {
            y: {
              easing: "easeInOutElastic",
              from: 0,
              duration: 1350,
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const p = ctx.raw || {};
                  return `${p.workerName || ctx.dataset.label}: Projects ${p.x || 0}, Income Rs ${money(p.y || 0)}, Experience ${p.expDays || 0} days`;
                },
              },
            },
          },
          scales: {
            x: {
              beginAtZero: true,
              title: { display: true, text: "Total Projects Done", color: axisTitleColor },
              ticks: { color: axisTextColor, precision: 0 },
              grid: { color: axisGridColor },
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Total Income Generated (Rs)", color: axisTitleColor },
              ticks: { color: axisTextColor, callback: (v) => money(v) },
              grid: { color: axisGridColor },
            },
          },
        },
      });
    }

    function applyThemeToCharts() {
      const isDarkMode = detectDarkMode();
      const axisTextColor = isDarkMode ? "#ffffff" : "#6b7280";
      const axisTitleColor = isDarkMode ? "#ffffff" : "#374151";
      const axisGridColor = isDarkMode ? "rgba(255,255,255,0.15)" : "rgba(107,114,128,0.12)";
      const totalLineColor = isDarkMode ? "#ffffff" : "#111827";

      const chart1 = window.teamChart1;
      if (chart1 && chart1.options && chart1.options.scales) {
        if (chart1.options.scales.x) {
          chart1.options.scales.x.ticks = chart1.options.scales.x.ticks || {};
          chart1.options.scales.x.grid = chart1.options.scales.x.grid || {};
          chart1.options.scales.x.ticks.color = axisTextColor;
          chart1.options.scales.x.grid.color = axisGridColor;
        }
        if (chart1.options.scales.income) {
          chart1.options.scales.income.ticks = chart1.options.scales.income.ticks || {};
          chart1.options.scales.income.title = chart1.options.scales.income.title || {};
          chart1.options.scales.income.grid = chart1.options.scales.income.grid || {};
          chart1.options.scales.income.ticks.color = axisTextColor;
          chart1.options.scales.income.title.color = axisTitleColor;
          chart1.options.scales.income.grid.color = axisGridColor;
        }
        if (chart1.options.scales.projects) {
          chart1.options.scales.projects.ticks = chart1.options.scales.projects.ticks || {};
          chart1.options.scales.projects.title = chart1.options.scales.projects.title || {};
          chart1.options.scales.projects.ticks.color = axisTextColor;
          chart1.options.scales.projects.title.color = axisTitleColor;
        }
        chart1.update("none");
      }

      const chart2 = window.teamChart2;
      if (chart2 && chart2.options && chart2.options.scales) {
        if (chart2.options.scales.x) {
          chart2.options.scales.x.ticks = chart2.options.scales.x.ticks || {};
          chart2.options.scales.x.title = chart2.options.scales.x.title || {};
          chart2.options.scales.x.grid = chart2.options.scales.x.grid || {};
          chart2.options.scales.x.ticks.color = axisTextColor;
          chart2.options.scales.x.title.color = axisTitleColor;
          chart2.options.scales.x.grid.color = axisGridColor;
        }
        if (chart2.options.scales.count) {
          chart2.options.scales.count.ticks = chart2.options.scales.count.ticks || {};
          chart2.options.scales.count.title = chart2.options.scales.count.title || {};
          chart2.options.scales.count.grid = chart2.options.scales.count.grid || {};
          chart2.options.scales.count.ticks.color = axisTextColor;
          chart2.options.scales.count.title.color = axisTitleColor;
          chart2.options.scales.count.grid.color = axisGridColor;
        }
        if (chart2.data && chart2.data.datasets && chart2.data.datasets[4]) {
          chart2.data.datasets[4].borderColor = totalLineColor;
          chart2.data.datasets[4].backgroundColor = totalLineColor;
        }
        chart2.update("none");
      }

      const chart3 = window.teamChart3;
      if (chart3 && chart3.options && chart3.options.scales) {
        if (chart3.options.scales.x) {
          chart3.options.scales.x.ticks = chart3.options.scales.x.ticks || {};
          chart3.options.scales.x.title = chart3.options.scales.x.title || {};
          chart3.options.scales.x.grid = chart3.options.scales.x.grid || {};
          chart3.options.scales.x.ticks.color = axisTextColor;
          chart3.options.scales.x.title.color = axisTitleColor;
          chart3.options.scales.x.grid.color = axisGridColor;
        }
        if (chart3.options.scales.y) {
          chart3.options.scales.y.ticks = chart3.options.scales.y.ticks || {};
          chart3.options.scales.y.title = chart3.options.scales.y.title || {};
          chart3.options.scales.y.grid = chart3.options.scales.y.grid || {};
          chart3.options.scales.y.ticks.color = axisTextColor;
          chart3.options.scales.y.title.color = axisTitleColor;
          chart3.options.scales.y.grid.color = axisGridColor;
        }
        chart3.update("none");
      }
    }

    function installThemeWatcher() {
      if (window.__teamThemeObserverInstalled) return;
      window.__teamThemeObserverInstalled = true;

      let frame = null;
      const scheduleThemeApply = () => {
        if (frame) cancelAnimationFrame(frame);
        frame = requestAnimationFrame(() => {
          frame = null;
          applyThemeToCharts();
        });
      };

      const observer = new MutationObserver(() => {
        // Mirror the category dashboard behavior: rebuild charts on theme class toggle.
        drawCharts();
        scheduleThemeApply();
      });
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class", "data-theme"],
      });
      observer.observe(document.body, {
        attributes: true,
        attributeFilter: ["class", "data-theme"],
      });

      window.addEventListener("themechange", scheduleThemeApply);
      window.addEventListener("storage", scheduleThemeApply);
    }

    if (window.Chart) {
      drawCharts();
      installThemeWatcher();
      applyThemeToCharts();
      return;
    }
    loadScript("https://cdn.jsdelivr.net/npm/chart.js").then(() => {
      drawCharts();
      installThemeWatcher();
      applyThemeToCharts();
    }).catch(() => {});
  })();
</script>
