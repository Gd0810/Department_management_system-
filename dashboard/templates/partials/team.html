{% include "tost.html" %}
<section class="w-full space-y-6 p-4 sm:p-6">
  <div class="theme-panel overflow-hidden rounded-2xl border shadow-sm">
    <div class="theme-panel-soft border-b px-4 py-5 sm:px-6">
      <h2 class="theme-text text-xl font-semibold tracking-tight">Team Dashboard</h2>
      <p class="theme-muted text-sm">Active team analytics and worker performance overview.</p>
    </div>

    <div class="space-y-6 p-4 sm:p-6">
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
        <div class="kpi-card kpi-count rounded-2xl overflow-hidden">
          <div class="kpi-fill-bg"></div>
          <div class="kpi-inner p-5">
            <p class="kpi-label mt-3">Total Staff Count</p>
            <p class="kpi-value">{{ staff_count }}</p>
          </div>
        </div>
        <div class="kpi-card kpi-count-share rounded-2xl overflow-hidden">
          <div class="kpi-fill-bg"></div>
          <div class="kpi-inner p-5">
            <p class="kpi-label mt-3">Total Intern Count</p>
            <p class="kpi-value">{{ intern_count }}</p>
          </div>
        </div>
        <div class="kpi-card kpi-income rounded-2xl overflow-hidden">
          <div class="kpi-fill-bg" style="width: {{ revenue_per_worker_share_pct|floatformat:2 }}%"></div>
          <div class="kpi-inner p-5">
            <div class="flex items-start justify-between mt-3 gap-2">
              <p class="kpi-label">Revenue per Worker</p>
              <span class="kpi-badge kpi-badge-cyan">{{ revenue_per_worker_share_pct|floatformat:2 }}%</span>
            </div>
            <p class="kpi-value">Rs {{ revenue_per_worker|floatformat:2 }}</p>
            <div class="kpi-bar-track mt-2">
              <div class="kpi-bar-fill kpi-bar-cyan" style="width: {{ revenue_per_worker_share_pct|floatformat:2 }}%"></div>
            </div>
            <p class="kpi-footnote mt-2">Avg income per worker with share %</p>
          </div>
        </div>
        <div class="kpi-card kpi-income-share rounded-2xl overflow-hidden">
          <div class="kpi-fill-bg" style="width: {{ completion_rate_pct|floatformat:2 }}%"></div>
          <div class="kpi-inner p-5">
            <div class="flex items-start justify-between mt-3 gap-2">
              <p class="kpi-label">Revenue per Worker x Completion Rate</p>
              <span class="kpi-badge kpi-badge-green">{{ completion_rate_pct|floatformat:2 }}%</span>
            </div>
            <p class="kpi-value">Rs {{ revenue_per_worker_completion_value|floatformat:2 }}</p>
            <div class="kpi-bar-track mt-2">
              <div class="kpi-bar-fill kpi-bar-green" style="width: {{ completion_rate_pct|floatformat:2 }}%"></div>
            </div>
            <p class="kpi-footnote mt-2">Completion uses finished project status</p>
          </div>
        </div>
      </div>

      <div class="theme-panel rounded-2xl border p-4 sm:p-5">
        <h3 class="theme-text mb-3 text-base font-semibold">Per Person Income vs Project Count</h3>
        <div class="relative h-[350px] w-full">
          <canvas id="workerIncomeProjectsChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <div class="theme-panel rounded-2xl border p-4 sm:p-5">
          <h3 class="theme-text mb-3 text-base font-semibold">Project Status Responsibility</h3>
          <div class="relative h-[320px] w-full">
            <canvas id="workerStatusChart"></canvas>
          </div>
        </div>
        <div class="theme-panel rounded-2xl border p-4 sm:p-5">
          <h3 class="theme-text mb-3 text-base font-semibold">Productivity vs Income vs Experience</h3>
          <div class="relative h-[320px] w-full">
            <canvas id="workerBubbleChart"></canvas>
          </div>
        </div>
      </div>

      <div class="theme-panel rounded-2xl border p-4 sm:p-5">
        <div class="mb-4 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
          <h3 class="theme-text text-base font-semibold">Worker Listing</h3>
          <div class="grid w-full grid-cols-1 gap-2 md:grid-cols-3 lg:w-auto">
            <input
              id="workerSearch"
              type="search"
              placeholder="Search name or email..."
              class="theme-input min-w-[220px] rounded-xl border px-3 py-2 text-sm outline-none transition"
            >
            <select id="workerTypeFilter" class="theme-input min-w-[150px] rounded-xl border px-3 py-2 text-sm outline-none transition">
              <option value="">All Worker Type</option>
              <option value="staff">Staff</option>
              <option value="intern">Intern</option>
            </select>
            <select id="workerStatusFilter" class="theme-input min-w-[170px] rounded-xl border px-3 py-2 text-sm outline-none transition">
              <option value="">All Working Status</option>
              <option value="joind">Joined</option>
              <option value="on board">On Board</option>
              <option value="relived">Relived</option>
            </select>
          </div>
        </div>
        <div class="overflow-auto" id="workerListingScroll" style="max-height: 430px;">
          <table class="w-full min-w-[850px] border-separate border-spacing-0 text-sm">
            <thead>
              <tr>
                <th class="theme-table-head rounded-tl-xl px-4 py-3 text-left">Name</th>
                <th class="theme-table-head px-4 py-3 text-left">Email</th>
                <th class="theme-table-head px-4 py-3 text-left">Date Of Join</th>
                <th class="theme-table-head px-4 py-3 text-left">Posting</th>
                <th class="theme-table-head rounded-tr-xl px-4 py-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="workerListingBody">
              {% for worker in workers %}
                <tr data-worker-row="1" data-worker-name="{{ worker.name|lower }}" data-worker-email="{{ worker.email|default:''|lower }}" data-worker-type="{{ worker.worker_type|lower }}" data-worker-status="{{ worker.working_status|lower }}">
                  <td class="theme-table-cell px-4 py-3">
                    <div class="flex items-center gap-3">
                      <div class="avatar-wrap">
                        {% if worker.image_url %}
                          <img src="{{ worker.image_url }}" alt="{{ worker.name }}" class="h-9 w-9 rounded-full object-cover">
                        {% else %}
                          <div class="avatar-fallback">{{ worker.initials }}</div>
                        {% endif %}
                        <span class="avatar-status-dot {% if worker.working_status == 'joind' %}dot-joined{% elif worker.working_status == 'on board' %}dot-onboard{% else %}dot-relived{% endif %}" title="{{ worker.working_status }}"></span>
                      </div>
                      <span class="font-semibold">{{ worker.name }}</span>
                    </div>
                  </td>
                  <td class="theme-table-cell px-4 py-3">{{ worker.email|default:"-" }}</td>
                  <td class="theme-table-cell px-4 py-3">{{ worker.date_of_join|date:"Y-m-d" }}</td>
                  <td class="theme-table-cell px-4 py-3">{{ worker.posting }}</td>
                  <td class="theme-table-cell px-4 py-3">
                    <div class="flex flex-wrap gap-2">
                      <button type="button" class="action-btn action-btn-view" onclick="alert('Worker view coming soon')">
                        <iconify-icon icon="material-symbols:visibility-rounded" width="16" height="16"></iconify-icon>
                        <span>View</span>
                      </button>
                      <button type="button" class="action-btn action-btn-update" onclick="alert('Worker update coming soon')">
                        <iconify-icon icon="material-symbols:edit-rounded" width="16" height="16"></iconify-icon>
                        <span>Update</span>
                      </button>
                      <button type="button" class="action-btn action-btn-delete" onclick="alert('Worker delete coming soon')">
                        <iconify-icon icon="material-symbols:delete-rounded" width="16" height="16"></iconify-icon>
                        <span>Delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td class="theme-table-cell px-4 py-4 text-center theme-muted" colspan="5">No workers available.</td>
                </tr>
              {% endfor %}
            </tbody>
            <tbody id="workerListingFilterEmpty" class="hidden">
              <tr>
                <td class="theme-table-cell px-4 py-4 text-center theme-muted" colspan="5">No workers match the selected filters.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

{{ worker_labels|json_script:"worker-labels" }}
{{ worker_income_values|json_script:"worker-income-values" }}
{{ worker_project_values|json_script:"worker-project-values" }}
{{ worker_experience_values|json_script:"worker-experience-values" }}
{{ worker_type_values|json_script:"worker-type-values" }}
{{ worker_image_urls|json_script:"worker-image-urls" }}
{{ worker_initials|json_script:"worker-initials" }}
{{ worker_finished_values|json_script:"worker-finished-values" }}
{{ worker_ongoing_values|json_script:"worker-ongoing-values" }}
{{ worker_on_hold_values|json_script:"worker-on-hold-values" }}
{{ worker_canceled_values|json_script:"worker-canceled-values" }}

<style>
  .kpi-card {
    border: 1px solid var(--panel-border);
    position: relative;
    min-height: 136px;
    background: var(--panel-bg);
  }
  .kpi-fill-bg {
    position: absolute;
    inset-block: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    transition: width 1.1s cubic-bezier(.4,0,.2,1);
    border-radius: inherit;
  }
  .kpi-inner { position: relative; z-index: 1; }
  .kpi-income { border-left: 4px solid #2563eb; }
  .kpi-income .kpi-fill-bg { background: linear-gradient(105deg,#2563eb22,#06b6d410); }
  .kpi-income-share { border-left: 4px solid #06b6d4; }
  .kpi-income-share .kpi-fill-bg { background: linear-gradient(105deg,#06b6d430,#0ea5e915); }
  .kpi-count { border-left: 4px solid #16a34a; }
  .kpi-count .kpi-fill-bg { background: linear-gradient(105deg,#16a34a22,#22c55e10); }
  .kpi-count-share { border-left: 4px solid #22c55e; }
  .kpi-count-share .kpi-fill-bg { background: linear-gradient(105deg,#22c55e30,#86efac15); }
  .kpi-label {
    color: var(--panel-muted);
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1.4;
    margin: 0;
  }
  .kpi-value {
    color: var(--panel-text);
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.15;
    margin-top: 0.2rem;
    letter-spacing: -0.025em;
  }
  .kpi-badge {
    display: inline-block;
    border-radius: 999px;
    padding: 0.12rem 0.55rem;
    font-size: 0.7rem;
    font-weight: 700;
    flex-shrink: 0;
    white-space: nowrap;
  }
  .kpi-badge-cyan { background:rgba(6,182,212,.14); color:#0891b2; }
  .kpi-badge-green { background:rgba(34,197,94,.14); color:#16a34a; }
  body.dark-theme .kpi-badge-cyan { background:rgba(6,182,212,.28); color:#22d3ee; }
  body.dark-theme .kpi-badge-green { background:rgba(34,197,94,.28); color:#4ade80; }
  .kpi-bar-track {
    width: 100%;
    height: 5px;
    border-radius: 999px;
    background: color-mix(in srgb,var(--panel-border) 55%,transparent);
    overflow: hidden;
  }
  .kpi-bar-fill {
    height: 100%;
    border-radius: 999px;
    transition: width 1.3s cubic-bezier(.4,0,.2,1);
  }
  .kpi-bar-cyan { background: linear-gradient(90deg,#06b6d4,#2563eb); }
  .kpi-bar-green { background: linear-gradient(90deg,#22c55e,#16a34a); }
  .kpi-footnote {
    color: var(--panel-muted);
    font-size: 0.69rem;
    line-height: 1.4;
  }
  .theme-table-head { border-top: 1px solid var(--panel-border); border-bottom: 1px solid var(--panel-border); background: var(--panel-soft-bg); color: var(--panel-text); font-weight: 600; }
  .theme-table-cell { border-bottom: 1px solid var(--panel-border); background: var(--panel-bg); color: var(--panel-text); }
  .avatar-wrap { position: relative; width: 2.25rem; height: 2.25rem; }
  .avatar-fallback {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: .76rem;
    font-weight: 700;
    color: #1d4ed8;
    background: #dbeafe;
    border: 1px solid #bfdbfe;
    text-transform: uppercase;
  }
  .avatar-status-dot {
    position: absolute;
    right: -1px;
    bottom: -1px;
    width: 0.62rem;
    height: 0.62rem;
    border-radius: 999px;
    border: 2px solid var(--panel-bg);
    box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.14);
  }
  .dot-joined { background: #facc15; }
  .dot-onboard { background: #22c55e; }
  .dot-relived { background: #ef4444; }
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border: 1px solid var(--panel-border);
    border-radius: 0.65rem;
    padding: 0.34rem 0.72rem;
    font-size: 0.76rem;
    font-weight: 700;
    color: var(--panel-text);
    background: var(--panel-soft-bg);
    transition: all 0.2s ease;
  }
  .action-btn-view { background: #e0edff; border-color: #bfdbfe; color: #1d4ed8; }
  .action-btn-update { background: #e7f9ef; border-color: #bbf7d0; color: #15803d; }
  .action-btn-delete { background: #fee2e2; border-color: #fecaca; color: #b91c1c; }
</style>

<script>
  (function () {
    if (window.teamDashboardCleanup) window.teamDashboardCleanup();

    const labels = JSON.parse(document.getElementById("worker-labels").textContent || "[]");
    const incomeValues = JSON.parse(document.getElementById("worker-income-values").textContent || "[]");
    const projectValues = JSON.parse(document.getElementById("worker-project-values").textContent || "[]");
    const experienceValues = JSON.parse(document.getElementById("worker-experience-values").textContent || "[]");
    const workerTypes = JSON.parse(document.getElementById("worker-type-values").textContent || "[]");
    const workerImageUrls = JSON.parse(document.getElementById("worker-image-urls").textContent || "[]");
    const workerInitials = JSON.parse(document.getElementById("worker-initials").textContent || "[]");
    const finishedValues = JSON.parse(document.getElementById("worker-finished-values").textContent || "[]");
    const ongoingValues = JSON.parse(document.getElementById("worker-ongoing-values").textContent || "[]");
    const onHoldValues = JSON.parse(document.getElementById("worker-on-hold-values").textContent || "[]");
    const canceledValues = JSON.parse(document.getElementById("worker-canceled-values").textContent || "[]");

    const incomeProjectCtx = document.getElementById("workerIncomeProjectsChart");
    const statusCtx = document.getElementById("workerStatusChart");
    const bubbleCtx = document.getElementById("workerBubbleChart");
    if (!incomeProjectCtx || !statusCtx || !bubbleCtx) return;
    let teamChart1 = null;
    let teamChart2 = null;
    let teamChart3 = null;
    let themeObserver = null;
    let themeFrame = null;
    let workerScrollWrap = null;
    let workerScrollHandler = null;
    let workerSearchInput = null;
    let workerTypeFilter = null;
    let workerStatusFilter = null;
    let workerFilterHandler = null;

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          if (existing.dataset.loaded === "true") resolve();
          else existing.addEventListener("load", () => resolve(), { once: true });
          return;
        }
        const script = document.createElement("script");
        script.src = src;
        script.onload = () => { script.dataset.loaded = "true"; resolve(); };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function money(v) { return Number(v || 0).toLocaleString("en-IN"); }
    function buildInitialAvatar(initials) {
      const canvas = document.createElement("canvas");
      canvas.width = 44;
      canvas.height = 44;
      const ctx = canvas.getContext("2d");
      if (!ctx) return canvas;
      ctx.fillStyle = "#dbeafe";
      ctx.strokeStyle = "#bfdbfe";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(22, 22, 20, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = "#1d4ed8";
      ctx.font = "700 15px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText((initials || "NA").toUpperCase().slice(0, 2), 22, 22);
      return canvas;
    }

    function buildPhotoAvatar(photoUrl, initials, chartRef, pointStyles, index) {
      if (!photoUrl) return;
      const image = new Image();
      image.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = 44;
        canvas.height = 44;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        ctx.save();
        ctx.beginPath();
        ctx.arc(22, 22, 20, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(image, 2, 2, 40, 40);
        ctx.restore();
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(22, 22, 20, 0, Math.PI * 2);
        ctx.stroke();
        pointStyles[index] = canvas;
        if (chartRef && chartRef.update) chartRef.update("none");
      };
      image.onerror = () => {
        pointStyles[index] = buildInitialAvatar(initials);
        if (chartRef && chartRef.update) chartRef.update("none");
      };
      image.src = photoUrl;
    }

    function detectDarkMode() {
      const root = document.documentElement;
      const body = document.body;
      return root.classList.contains("dark-theme")
        || body.classList.contains("dark-theme")
        || root.classList.contains("dark")
        || body.classList.contains("dark")
        || root.getAttribute("data-theme") === "dark"
        || body.getAttribute("data-theme") === "dark";
    }

    function drawCharts() {
      const isDarkMode = detectDarkMode();
      const axisTextColor = isDarkMode ? "#ffffff" : "#6b7280";
      const axisTitleColor = isDarkMode ? "#ffffff" : "#374151";
      const axisGridColor = isDarkMode ? "rgba(255,255,255,0.15)" : "rgba(107,114,128,0.12)";
      const totalLineColor = isDarkMode ? "#ffffff" : "#111827";
      const avatarPointStyles = labels.map((_, idx) => buildInitialAvatar(workerInitials[idx]));

      if (teamChart1) teamChart1.destroy();
      if (teamChart2) teamChart2.destroy();
      if (teamChart3) teamChart3.destroy();

      teamChart1 = new Chart(incomeProjectCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Per Person Income (Rs)",
              data: incomeValues,
              yAxisID: "income",
              borderColor: "#7072FF",
              backgroundColor: "rgba(112, 114, 255, 0.15)",
              tension: 0.35,
              fill: true,
              pointStyle: avatarPointStyles,
              pointRadius: 9,
              pointHoverRadius: 11,
            },
            {
              label: "Per Person Project Count",
              data: projectValues,
              yAxisID: "projects",
              borderColor: "#33C494",
              backgroundColor: "rgba(51, 196, 148, 0.15)",
              tension: 0.35,
              fill: true,
              pointStyle: avatarPointStyles,
              pointRadius: 9,
              pointHoverRadius: 11,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1200,
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 80) + (ctx.datasetIndex * 120) : 0),
          },
          scales: {
            x: {
              ticks: { color: axisTextColor },
              grid: { color: axisGridColor },
            },
            income: {
              position: "left",
              ticks: { color: axisTextColor, callback: (v) => money(v) },
              title: { display: true, text: "Income (Rs)", color: axisTitleColor },
              grid: { color: axisGridColor },
            },
            projects: {
              position: "right",
              title: { display: true, text: "Project Count", color: axisTitleColor },
              grid: { drawOnChartArea: false },
              ticks: { color: axisTextColor, precision: 0 },
            },
          },
        },
      });
      workerImageUrls.forEach((url, idx) => buildPhotoAvatar(url, workerInitials[idx], teamChart1, avatarPointStyles, idx));

      teamChart2 = new Chart(statusCtx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Finished",
              data: finishedValues,
              stack: "status",
              backgroundColor: "rgba(51, 196, 148, 0.85)",
              borderColor: "#33C494",
              borderWidth: 1,
            },
            {
              label: "Ongoing",
              data: ongoingValues,
              stack: "status",
              backgroundColor: "rgba(112, 114, 255, 0.85)",
              borderColor: "#7072FF",
              borderWidth: 1,
            },
            {
              label: "On Hold",
              data: onHoldValues,
              stack: "status",
              backgroundColor: "rgba(245, 158, 11, 0.85)",
              borderColor: "#f59e0b",
              borderWidth: 1,
            },
            {
              label: "Cancelled",
              data: canceledValues,
              stack: "status",
              backgroundColor: "rgba(239, 68, 68, 0.85)",
              borderColor: "#ef4444",
              borderWidth: 1,
            },
            {
              type: "line",
              label: "Total Assigned Projects",
              data: labels.map((_, idx) => Number(finishedValues[idx] || 0) + Number(ongoingValues[idx] || 0) + Number(onHoldValues[idx] || 0) + Number(canceledValues[idx] || 0)),
              yAxisID: "count",
              borderColor: totalLineColor,
              backgroundColor: totalLineColor,
              pointRadius: 3,
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1300,
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 70) + (ctx.datasetIndex * 110) : 0),
          },
          animations: {
            y: {
              easing: "easeInOutElastic",
              from: 0,
              duration: 1400,
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y || 0}`,
              },
            },
          },
          scales: {
            x: {
              stacked: true,
              ticks: { color: axisTextColor, maxRotation: 40, minRotation: 0 },
              title: { display: true, text: "Worker", color: axisTitleColor },
              grid: { color: axisGridColor },
            },
            count: {
              beginAtZero: true,
              stacked: true,
              ticks: {
                color: axisTextColor,
                precision: 0,
              },
              title: {
                display: true,
                text: "Project Count",
                color: axisTitleColor,
              },
              grid: { color: axisGridColor },
            },
          },
        },
      });

      const staffPoints = [];
      const internPoints = [];
      for (let i = 0; i < labels.length; i += 1) {
        const point = {
          x: Number(projectValues[i] || 0),
          y: Number(incomeValues[i] || 0),
          r: Math.max(5, Math.min(24, Math.sqrt(Number(experienceValues[i] || 0)))),
          workerName: labels[i],
          expDays: Number(experienceValues[i] || 0),
        };
        if ((workerTypes[i] || "").toLowerCase() === "staff") staffPoints.push(point);
        else internPoints.push(point);
      }

      teamChart3 = new Chart(bubbleCtx, {
        type: "bubble",
        data: {
          datasets: [
            {
              label: "Staff",
              data: staffPoints,
              borderColor: "#7072FF",
              backgroundColor: "rgba(112, 114, 255, 0.35)",
            },
            {
              label: "Intern",
              data: internPoints,
              borderColor: "#33C494",
              backgroundColor: "rgba(51, 196, 148, 0.35)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1200,
            delay: (ctx) => (ctx.type === "data" ? (ctx.dataIndex * 90) + (ctx.datasetIndex * 120) : 0),
          },
          animations: {
            y: {
              easing: "easeInOutElastic",
              from: 0,
              duration: 1350,
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const p = ctx.raw || {};
                  return `${p.workerName || ctx.dataset.label}: Projects ${p.x || 0}, Income Rs ${money(p.y || 0)}, Experience ${p.expDays || 0} days`;
                },
              },
            },
          },
          scales: {
            x: {
              beginAtZero: true,
              title: { display: true, text: "Total Projects Done", color: axisTitleColor },
              ticks: { color: axisTextColor, precision: 0 },
              grid: { color: axisGridColor },
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Total Income Generated (Rs)", color: axisTitleColor },
              ticks: { color: axisTextColor, callback: (v) => money(v) },
              grid: { color: axisGridColor },
            },
          },
        },
      });
    }

    function applyThemeToCharts() {
      const isDarkMode = detectDarkMode();
      const axisTextColor = isDarkMode ? "#ffffff" : "#6b7280";
      const axisTitleColor = isDarkMode ? "#ffffff" : "#374151";
      const axisGridColor = isDarkMode ? "rgba(255,255,255,0.15)" : "rgba(107,114,128,0.12)";
      const totalLineColor = isDarkMode ? "#ffffff" : "#111827";

      const chart1 = teamChart1;
      if (chart1 && chart1.options && chart1.options.scales) {
        if (chart1.options.scales.x) {
          chart1.options.scales.x.ticks = chart1.options.scales.x.ticks || {};
          chart1.options.scales.x.grid = chart1.options.scales.x.grid || {};
          chart1.options.scales.x.ticks.color = axisTextColor;
          chart1.options.scales.x.grid.color = axisGridColor;
        }
        if (chart1.options.scales.income) {
          chart1.options.scales.income.ticks = chart1.options.scales.income.ticks || {};
          chart1.options.scales.income.title = chart1.options.scales.income.title || {};
          chart1.options.scales.income.grid = chart1.options.scales.income.grid || {};
          chart1.options.scales.income.ticks.color = axisTextColor;
          chart1.options.scales.income.title.color = axisTitleColor;
          chart1.options.scales.income.grid.color = axisGridColor;
        }
        if (chart1.options.scales.projects) {
          chart1.options.scales.projects.ticks = chart1.options.scales.projects.ticks || {};
          chart1.options.scales.projects.title = chart1.options.scales.projects.title || {};
          chart1.options.scales.projects.ticks.color = axisTextColor;
          chart1.options.scales.projects.title.color = axisTitleColor;
        }
        chart1.update("none");
      }

      const chart2 = teamChart2;
      if (chart2 && chart2.options && chart2.options.scales) {
        if (chart2.options.scales.x) {
          chart2.options.scales.x.ticks = chart2.options.scales.x.ticks || {};
          chart2.options.scales.x.title = chart2.options.scales.x.title || {};
          chart2.options.scales.x.grid = chart2.options.scales.x.grid || {};
          chart2.options.scales.x.ticks.color = axisTextColor;
          chart2.options.scales.x.title.color = axisTitleColor;
          chart2.options.scales.x.grid.color = axisGridColor;
        }
        if (chart2.options.scales.count) {
          chart2.options.scales.count.ticks = chart2.options.scales.count.ticks || {};
          chart2.options.scales.count.title = chart2.options.scales.count.title || {};
          chart2.options.scales.count.grid = chart2.options.scales.count.grid || {};
          chart2.options.scales.count.ticks.color = axisTextColor;
          chart2.options.scales.count.title.color = axisTitleColor;
          chart2.options.scales.count.grid.color = axisGridColor;
        }
        if (chart2.data && chart2.data.datasets && chart2.data.datasets[4]) {
          chart2.data.datasets[4].borderColor = totalLineColor;
          chart2.data.datasets[4].backgroundColor = totalLineColor;
        }
        chart2.update("none");
      }

      const chart3 = teamChart3;
      if (chart3 && chart3.options && chart3.options.scales) {
        if (chart3.options.scales.x) {
          chart3.options.scales.x.ticks = chart3.options.scales.x.ticks || {};
          chart3.options.scales.x.title = chart3.options.scales.x.title || {};
          chart3.options.scales.x.grid = chart3.options.scales.x.grid || {};
          chart3.options.scales.x.ticks.color = axisTextColor;
          chart3.options.scales.x.title.color = axisTitleColor;
          chart3.options.scales.x.grid.color = axisGridColor;
        }
        if (chart3.options.scales.y) {
          chart3.options.scales.y.ticks = chart3.options.scales.y.ticks || {};
          chart3.options.scales.y.title = chart3.options.scales.y.title || {};
          chart3.options.scales.y.grid = chart3.options.scales.y.grid || {};
          chart3.options.scales.y.ticks.color = axisTextColor;
          chart3.options.scales.y.title.color = axisTitleColor;
          chart3.options.scales.y.grid.color = axisGridColor;
        }
        chart3.update("none");
      }
    }

    function installThemeWatcher() {
      const scheduleThemeApply = () => {
        if (themeFrame) cancelAnimationFrame(themeFrame);
        themeFrame = requestAnimationFrame(() => {
          themeFrame = null;
          applyThemeToCharts();
        });
      };

      if (themeObserver) themeObserver.disconnect();
      themeObserver = new MutationObserver(() => {
        drawCharts();
        scheduleThemeApply();
      });
      themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class", "data-theme"],
      });
      themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ["class", "data-theme"],
      });

      window.addEventListener("themechange", scheduleThemeApply);
      window.addEventListener("storage", scheduleThemeApply);

      window.teamDashboardCleanup = function () {
        window.removeEventListener("themechange", scheduleThemeApply);
        window.removeEventListener("storage", scheduleThemeApply);
        if (workerScrollWrap && workerScrollHandler) {
          workerScrollWrap.removeEventListener("scroll", workerScrollHandler);
          workerScrollHandler = null;
        }
        if (workerSearchInput && workerFilterHandler) {
          workerSearchInput.removeEventListener("input", workerFilterHandler);
        }
        if (workerTypeFilter && workerFilterHandler) {
          workerTypeFilter.removeEventListener("change", workerFilterHandler);
        }
        if (workerStatusFilter && workerFilterHandler) {
          workerStatusFilter.removeEventListener("change", workerFilterHandler);
        }
        workerFilterHandler = null;
        if (themeObserver) {
          themeObserver.disconnect();
          themeObserver = null;
        }
        if (themeFrame) {
          cancelAnimationFrame(themeFrame);
          themeFrame = null;
        }
        if (teamChart1) {
          teamChart1.destroy();
          teamChart1 = null;
        }
        if (teamChart2) {
          teamChart2.destroy();
          teamChart2 = null;
        }
        if (teamChart3) {
          teamChart3.destroy();
          teamChart3 = null;
        }
      };
    }

    function initWorkerListingLazyScroll() {
      workerScrollWrap = document.getElementById("workerListingScroll");
      const workerListingBody = document.getElementById("workerListingBody");
      const workerFilterEmpty = document.getElementById("workerListingFilterEmpty");
      workerSearchInput = document.getElementById("workerSearch");
      workerTypeFilter = document.getElementById("workerTypeFilter");
      workerStatusFilter = document.getElementById("workerStatusFilter");
      if (!workerScrollWrap || !workerListingBody || !workerFilterEmpty || !workerSearchInput || !workerTypeFilter || !workerStatusFilter) return;

      const rows = Array.from(workerListingBody.querySelectorAll('tr[data-worker-row="1"]'));
      const pageSize = 7;
      if (!rows.length) return;

      let filteredRows = rows.slice();
      let visibleCount = 0;

      const hideAllRows = () => {
        rows.forEach((row) => {
          row.style.display = "none";
        });
      };

      const loadMoreRows = () => {
        if (visibleCount >= filteredRows.length) return;
        const nextCount = Math.min(visibleCount + pageSize, filteredRows.length);
        for (let i = visibleCount; i < nextCount; i += 1) {
          filteredRows[i].style.display = "";
        }
        visibleCount = nextCount;
      };

      const applyWorkerFilters = () => {
        const query = (workerSearchInput.value || "").trim().toLowerCase();
        const selectedType = (workerTypeFilter.value || "").trim().toLowerCase();
        const selectedStatus = (workerStatusFilter.value || "").trim().toLowerCase();

        filteredRows = rows.filter((row) => {
          const name = (row.dataset.workerName || "").toLowerCase();
          const email = (row.dataset.workerEmail || "").toLowerCase();
          const type = (row.dataset.workerType || "").toLowerCase();
          const status = (row.dataset.workerStatus || "").toLowerCase();

          const searchOk = !query || name.includes(query) || email.includes(query);
          const typeOk = !selectedType || type === selectedType;
          const statusOk = !selectedStatus || status === selectedStatus;
          return searchOk && typeOk && statusOk;
        });

        hideAllRows();
        visibleCount = 0;
        workerFilterEmpty.classList.toggle("hidden", filteredRows.length !== 0);
        if (filteredRows.length) {
          loadMoreRows();
        }
        workerScrollWrap.scrollTop = 0;
      };

      workerScrollHandler = () => {
        const threshold = 100;
        const nearBottom = workerScrollWrap.scrollTop + workerScrollWrap.clientHeight >= workerScrollWrap.scrollHeight - threshold;
        if (nearBottom) loadMoreRows();
      };
      workerScrollWrap.addEventListener("scroll", workerScrollHandler);

      workerFilterHandler = applyWorkerFilters;
      workerSearchInput.addEventListener("input", workerFilterHandler);
      workerTypeFilter.addEventListener("change", workerFilterHandler);
      workerStatusFilter.addEventListener("change", workerFilterHandler);

      applyWorkerFilters();
    }

    if (window.Chart) {
      initWorkerListingLazyScroll();
      drawCharts();
      installThemeWatcher();
      applyThemeToCharts();
      return;
    }
    loadScript("https://cdn.jsdelivr.net/npm/chart.js").then(() => {
      initWorkerListingLazyScroll();
      drawCharts();
      installThemeWatcher();
      applyThemeToCharts();
    }).catch(() => {});
  })();
</script>
