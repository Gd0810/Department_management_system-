{% include "tost.html" %}

<div id="assignProjectRoot" class="form-loading">
  {% include "partials/components/form_skeleton_markup.html" %}
  <div class="form-real">
<section class="w-full max-w-none px-3 py-4 sm:px-4 lg:px-6">
  <div class="theme-panel overflow-hidden rounded-2xl border shadow-sm transition-colors">
    <div class="theme-panel-soft border-b px-4 py-5 sm:px-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
        <div class="flex items-center gap-3">
          <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-indigo-600 text-white shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 7h-8V3H4a2 2 0 0 0-2 2v10a4 4 0 0 0 4 4h8v4h8a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Zm-7 9-3-3 1.41-1.41L13 13.17l3.59-3.58L18 11l-5 5Z"/>
            </svg>
          </div>
          <div>
            <h2 class="theme-text text-xl font-semibold tracking-tight">Assign Project Member</h2>
            <p class="theme-muted text-sm">Map a worker to a project with contribution level.</p>
          </div>
        </div>

        <div class="w-full md:w-64">
          <label for="project_category" class="theme-text mb-1.5 block text-sm font-medium">PROJECT_CATEGORY</label>
          <select id="project_category" name="project_category" class="theme-input w-full rounded-xl border py-2.5 px-3 outline-none transition">
            <option value="">All</option>
            {% for category_key, category_label in project_categories %}
              <option value="{{ category_key }}" {% if form_data.project_category == category_key %}selected{% endif %}>{{ category_label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="px-4 py-5 sm:px-6">
      <form
        method="post"
        action="{% url 'assign_project' %}"
        hx-post="{% url 'assign_project' %}"
        hx-target="#content"
        hx-swap="innerHTML"
        class="space-y-5"
      >
        {% csrf_token %}

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="project" class="theme-text mb-1.5 block text-sm font-medium">Project</label>
            <div class="relative">
              <span class="theme-muted pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6a3 3 0 0 1 3-3h5v6H3V6Zm0 6h8v9H6a3 3 0 0 1-3-3v-6Zm10 9v-9h8v6a3 3 0 0 1-3 3h-5Zm0-18h5a3 3 0 0 1 3 3v3h-8V3Z"/></svg>
              </span>
              <select id="project" name="project" required class="theme-input w-full rounded-xl border py-2.5 pl-10 pr-3 outline-none transition">
                <option value="">Select Project</option>
                {% for project in projects %}
                  <option value="{{ project.id }}" data-category="{{ project.category }}" {% if form_data.project == project.id|stringformat:"s" %}selected{% endif %}>
                    {{ project.title }} ({{ project.get_work_type_display }})
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div>
            <label for="worker" class="theme-text mb-1.5 block text-sm font-medium">Worker</label>
            <div class="relative">
              <span class="theme-muted pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.41 0-8 2.24-8 5v1h16v-1c0-2.76-3.59-5-8-5Z"/></svg>
              </span>
              <select id="worker" name="worker" required class="theme-input w-full rounded-xl border py-2.5 pl-10 pr-3 outline-none transition">
                <option value="">Select Worker</option>
                {% for worker in workers %}
                  <option value="{{ worker.id }}" {% if form_data.worker == worker.id|stringformat:"s" %}selected{% endif %}>
                    {{ worker.name }} ({{ worker.get_worker_type_display }})
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="md:col-span-2">
            <label for="contribution" class="theme-text mb-1.5 block text-sm font-medium">Contribution</label>
            <div class="relative">
              <span class="theme-muted pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2 9.5 9H2l6 4.5L5.5 22 12 17.5 18.5 22 16 13.5 22 9h-7.5L12 2Z"/></svg>
              </span>
              <select id="contribution" name="contribution" class="theme-input w-full rounded-xl border py-2.5 pl-10 pr-3 outline-none transition">
                <option value="gold" {% if form_data.contribution|default:'gold' == 'gold' %}selected{% endif %}>Gold</option>
                <option value="silver" {% if form_data.contribution == 'silver' %}selected{% endif %}>Silver</option>
                <option value="copper" {% if form_data.contribution == 'copper' %}selected{% endif %}>Copper</option>
              </select>
            </div>
           
          </div>
        </div>

        <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
          <button type="reset" class="theme-btn-secondary inline-flex items-center justify-center rounded-xl border px-5 py-2.5 text-sm font-medium transition">
            Clear
          </button>
          <button type="submit" class="theme-btn-primary inline-flex items-center justify-center gap-2 rounded-xl px-5 py-2.5 text-sm font-semibold shadow-md transition focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>
            Assign Member
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
  </div>
</div>
{% include "partials/components/form_skeleton_assets.html" with skeleton_root_id="assignProjectRoot" skeleton_delay_ms=420 %}
<script>
  (function () {
    const categorySelect = document.getElementById("project_category");
    const projectSelect = document.getElementById("project");
    if (!categorySelect || !projectSelect) return;

    const projectOptions = Array.from(projectSelect.options).slice(1);

    function filterProjectsByCategory() {
      const selectedCategory = categorySelect.value;
      let selectedStillVisible = false;

      projectOptions.forEach((option) => {
        const matches = !selectedCategory || option.dataset.category === selectedCategory;
        option.hidden = !matches;
        option.disabled = !matches;
        if (matches && option.selected) selectedStillVisible = true;
      });

      if (!selectedStillVisible) projectSelect.value = "";
    }

    categorySelect.addEventListener("change", filterProjectsByCategory);
    filterProjectsByCategory();
  })();
</script>
